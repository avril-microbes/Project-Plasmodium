---
title: "R Notebook"
output: html_notebook
---
```{r}
library(dplyr)
library(ggplot2)
library(here)
library(deSolve)
library(crone)
library(optimParallel)
library(doParallel)
library(doRNG)
library(arrow)
library(stringr)
library(parallel)
library(ggpubr)
library(DEoptim)
library(marqLevAlg)
```

```{r}
parameters_tsukushi <- c(R1 = 8.89*10^6, # slightly higher
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 8*10^-6, # doubled form original
                alpha = 1, 
                alphag = 2, 
                beta = 5.721, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1,
                psin = 16.69234,
                psiw = 0.8431785,
                phin = 0.03520591, 
                phiw = 550.842,
                iota = 2.18*(10^6),
                rho = 0.2627156)

time_range <- seq(0, 20, by = 1e-3)
```


```{r}
source(here("functions/chabaudi_si_clean.R"))
```

# trying DE optim. works although slow
```{r}
res <- DEoptim(
    fn = chabaudi_si_clean, 
    control = list(trace = 1, parallelType = 1),
    lower = c(-1, -100, -1000, -5000),
    upper = c(1, 100, 1000, 5000),
    immunity = "tsukushi",
    parameters = parameters_tsukushi,
    time_range = time_range,
    cue = "I",
    log_cue = "log10",
    cue_range = seq(0, 6*(10^6), by = (6*(10^6))/5000),
    solver = "vode",
    neg = T)
```

# trying DE optim coinfection
```{r}
source(here("functions/co_infection_opt_do.R"))
source(here("functions/chabaudi_ci_clean.R"))
source(here("functions/co_infection_opt_alt.R"))
```

# Ig alone logged
note started at 0.5x4.
```{r}
ci_Ig_log_opt <- co_infection_opt_do(parameters_cr = c(0.359066,  -65.485796,  344.211487, -438.589440),
                             limit = 0.01,
                             model = chabaudi_ci_clean,
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = time_range,
                             cue_1 = "Ig1",
                             cue_2 = "Ig2",
                             cue_range_1 = seq(0, log10(6*(10^6)), by = log10(6*(10^6))/5000),
                             cue_range_2 = seq(0, log10(6*(10^6)), by = log10(6*(10^6))/5000),
                             solver = "vode",
                             log_cue_1 = "log10",
                             log_cue_2 = "log10",
                             neg = T)
```

# trying alt where last round of 
```{r}
ci_Ig_log_opt <- co_infection_opt_alt(parameters_cr = c(35.6294,	-65.6898,	-11.5609,	-52.0779),
                             limit = 0.01,
                             model = chabaudi_ci_clean,
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = time_range,
                             cue_1 = "Ig1",
                             cue_2 = "Ig2",
                             cue_range_1 = seq(0, log10(6*(10^6)), by = log10(6*(10^6))/5000),
                             cue_range_2 = seq(0, log10(6*(10^6)), by = log10(6*(10^6))/5000),
                             solver = "vode",
                             log_cue_1 = "log10",
                             log_cue_2 = "log10")
```


