---
title: "report7"
output: html_document
---
# Load libraries
```{r}
library(deSolve)
library(splines)
library(optimParallel)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(magrittr)
library(Rcpp)
library(microbenchmark)
library(GA)
library(here)
```

# Load functions
```{r}
source(here("functions/chabaudi_ci_opt_lag.R"))
source(here("functions/co_infection_opt.R"))
source(here("functions/par_to_df.R"))
source(here("functions/chabaudi_si_opt_lag.R"))
source(here("functions/total_parasite.R"))
source(here("functions/test.R"))
```
# define parameters
```{r}
parameters <- c(R1 = 8.5*10^6,
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 4*10^-6,
                alpha = 1, 
                alphag = 2, 
                beta = 10, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1)

parameters_tsukushi <- c(R1 = 8.89*10^6, # slightly higher
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 8*10^-6, # doubled form original
                alpha = 1, 
                alphag = 2, 
                beta = 5.721, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1,
                psin = 16.69234,
                psiw = 0.8431785,
                phin = 0.03520591, 
                phiw = 550.842,
                iota = 2.18*(10^6),
                rho = 0.2627156,
                mud = -log(1-0.94)) # drug induced action. 94% death per day

time_range <- seq(0, 20, by = 1e-3)
I_range <- seq(0, 2.18*10^6, by = 1000) 
I_range_large <- seq(0, (3.7*10^5)*(8.5*10^6)/((3.7*10^5)-0.025*(8.5*10^6)), by = 1000) 
I_range_mid <- seq(0, 5*10^6, by = 1000)
I_range_mid2 <- seq(0, 4*10^6, by = 1000)
I_range_mid4 <- seq(0, 6*10^6, by = (6*10^6)/5000)

# logged counterpart
I_range_mid2_log <- seq(0, log(4*10^6), by = log(4*10^6)/5000)
I_range_mid3_log <- seq(0, log(5*10^6), by = log(5*10^6)/5000)
I_range_mid4_log <- seq(0, log(6*10^6), by = log(6*10^6)/5000)
I_range_mid4_log10 <- seq(0, log10(6*10^6), by = log10(6*10^6)/5000)
I_range_large_log10 <- seq(0, log10((3.7*10^5)*(8.5*10^6)/((3.7*10^5)-0.025*(8.5*10^6))), by = log10((3.7*10^5)*(8.5*10^6)/((3.7*10^5)-0.025*(8.5*10^6)))/10000)

```

# minimum parasite density
```{r}
lag_ci_I_20.dyn_tsukushi_I <- chabaudi_si_opt_lag(par = c(360.3151, -470.3701, -325.4047, -371.3250),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 0,
                             admin = 0)

lag_si_I_20.dyn_tsukushi_pyr10_0 <- chabaudi_si_opt_lag(par = c(5.511734, 2.394041,-17.890312,4.598348),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 0,
                             admin = 0)

lag_si_I_20.dyn_tsukushi_pyr10_2 <- chabaudi_si_opt_lag(par = c(8.201441,  -2.213959, -17.284309,  -1.756720),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 2)


lag_si_I_20.dyn_tsukushi_pyr10_4 <- chabaudi_si_opt_lag(par = c(8.884728,   5.476709, -26.454302,   3.662202),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 4)

lag_si_I_20.dyn_tsukushi_pyr10_6 <- chabaudi_si_opt_lag(par = c(3.6628282,  3.9509224, -9.8626175, -0.9511553),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 6)

lag_si_I_20.dyn_tsukushi_pyr10_8 <- chabaudi_si_opt_lag(par = c(7.189790,   3.242118, -22.455428,   6.506670),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 8)

lag_si_I_20.dyn_tsukushi_pyr10_10 <- chabaudi_si_opt_lag(par = c(32.6085, -12.2148, -75.6596, 13.0708 ),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 10)

lag_si_I_20.dyn_tsukushi_pyr10_12 <- chabaudi_si_opt_lag(par =c(4.2893474 ,  3.6860976, -13.0873430,   0.8359934),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 12)

lag_si_I_20.dyn_tsukushi_pyr10_14 <- chabaudi_si_opt_lag(par = c(4.462606,   3.192332, -13.850205,   1.720999),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 14)

lag_si_I_20.dyn_tsukushi_pyr10_16 <- chabaudi_si_opt_lag(par = c(5.416104,   2.763324, -16.706358,   2.931262),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 16)
```

# default optimal single rate conversion stratey with drug administration
```{r}
lag_si_I_20.dyn_tsukushi_pyr10_2_si <- chabaudi_si_opt_lag(par = c(5.511734, 2.394041,-17.890312,4.598348),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 2)

lag_si_I_20.dyn_tsukushi_pyr10_4_si <- chabaudi_si_opt_lag(par = c(5.511734, 2.394041,-17.890312,4.598348),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 4)

lag_si_I_20.dyn_tsukushi_pyr10_6_si <- chabaudi_si_opt_lag(par = c(5.511734, 2.394041,-17.890312,4.598348),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 6)

lag_si_I_20.dyn_tsukushi_pyr10_8_si <- chabaudi_si_opt_lag(par = c(5.511734, 2.394041,-17.890312,4.598348),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 8)

lag_si_I_20.dyn_tsukushi_pyr10_10_si <- chabaudi_si_opt_lag(par = c(5.511734, 2.394041,-17.890312,4.598348),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 10)

lag_si_I_20.dyn_tsukushi_pyr10_12_si <- chabaudi_si_opt_lag(par = c(5.511734, 2.394041,-17.890312,4.598348),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 12)

lag_si_I_20.dyn_tsukushi_pyr10_14_si <- chabaudi_si_opt_lag(par = c(5.511734, 2.394041,-17.890312,4.598348),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 14)

lag_si_I_20.dyn_tsukushi_pyr10_16_si <- chabaudi_si_opt_lag(par = c(5.511734, 2.394041,-17.890312,4.598348),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 10,
                             admin = 16)
```


# get minimum infected RBC during drug treatment (day at treatment and at end of treatment)
```{r}
date <- c(2, 4, 6, 8, 10, 12, 14, 16)

# iRBC count @ of treatment and after treatment (asexual)
i_opt_drug <- rbind(
  lag_si_I_20.dyn_tsukushi_pyr10_2 %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 2) %>% 
  dplyr::filter(time < 2+3.557-2.586/(1+exp(-8.821+2))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_4 %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 4) %>% 
  dplyr::filter(time < 4+3.557-2.586/(1+exp(-8.821+4))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_6 %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 6) %>% 
  dplyr::filter(time < 6+3.557-2.586/(1+exp(-8.821+6))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_8 %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 8) %>% 
  dplyr::filter(time < 8+3.557-2.586/(1+exp(-8.821+8))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_10 %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 10) %>% 
  dplyr::filter(time < 10+3.557-2.586/(1+exp(-8.821+10))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_12 %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 12) %>% 
  dplyr::filter(time < 12+3.557-2.586/(1+exp(-8.821+12))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_14 %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 14) %>% 
  dplyr::filter(time < 14+3.557-2.586/(1+exp(-8.821+14))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_16 %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 16) %>% 
  dplyr::filter(time < 16+3.557-2.586/(1+exp(-8.821+16))) %>% 
  dplyr::summarise(max = max(value), min = min(value))
  )

# ig
ig_opt_drug <- rbind(
  lag_si_I_20.dyn_tsukushi_pyr10_2 %>% 
  dplyr::filter(variable == "Ig") %>% 
  dplyr::filter(time > 2) %>% 
  dplyr::filter(time < 2+3.557-2.586/(1+exp(-8.821+2))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_4 %>% 
  dplyr::filter(variable == "Ig") %>% 
  dplyr::filter(time > 4) %>% 
  dplyr::filter(time < 4+3.557-2.586/(1+exp(-8.821+4))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_6 %>% 
  dplyr::filter(variable == "Ig") %>% 
  dplyr::filter(time > 6) %>% 
  dplyr::filter(time < 6+3.557-2.586/(1+exp(-8.821+6))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_8 %>% 
  dplyr::filter(variable == "Ig") %>% 
  dplyr::filter(time > 8) %>% 
  dplyr::filter(time < 8+3.557-2.586/(1+exp(-8.821+8))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_10 %>% 
  dplyr::filter(variable == "Ig") %>% 
  dplyr::filter(time > 10) %>% 
  dplyr::filter(time < 10+3.557-2.586/(1+exp(-8.821+10))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_12 %>% 
  dplyr::filter(variable == "Ig") %>% 
  dplyr::filter(time > 12) %>% 
  dplyr::filter(time < 12+3.557-2.586/(1+exp(-8.821+12))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_14 %>% 
  dplyr::filter(variable == "Ig") %>% 
  dplyr::filter(time > 14) %>% 
  dplyr::filter(time < 14+3.557-2.586/(1+exp(-8.821+14))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_16 %>% 
  dplyr::filter(variable == "Ig") %>% 
  dplyr::filter(time > 16) %>% 
  dplyr::filter(time < 16+3.557-2.586/(1+exp(-8.821+16))) %>% 
  dplyr::summarise(max = max(value), min = min(value))
  )

# fix naming
names(i_opt_drug) <- c("max_I_opt", "min_I_opt")
names(ig_opt_drug) <- c("max_Ig_opt", "min_Ig_opt")

```

# get single infection with drug administration
```{r}
i_si_drug <- rbind(
  lag_si_I_20.dyn_tsukushi_pyr10_2_si %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 2) %>% 
  dplyr::filter(time < 2+3.557-2.586/(1+exp(-8.821+2))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_4_si %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 4) %>% 
  dplyr::filter(time < 4+3.557-2.586/(1+exp(-8.821+4))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_6_si %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 6) %>% 
  dplyr::filter(time < 6+3.557-2.586/(1+exp(-8.821+6))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_8_si %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 8) %>% 
  dplyr::filter(time < 8+3.557-2.586/(1+exp(-8.821+8))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_10_si %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 10) %>% 
  dplyr::filter(time < 10+3.557-2.586/(1+exp(-8.821+10))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_12_si %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 12) %>% 
  dplyr::filter(time < 12+3.557-2.586/(1+exp(-8.821+12))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_14_si %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 14) %>% 
  dplyr::filter(time < 14+3.557-2.586/(1+exp(-8.821+14))) %>% 
  dplyr::summarise(max = max(value), min = min(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_16_si %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 16) %>% 
  dplyr::filter(time < 16+3.557-2.586/(1+exp(-8.821+16))) %>% 
  dplyr::summarise(max = max(value), min = min(value))
  )

names(i_si_drug) <- c("max_I_si", "min_I_si")
```

# difference in iRBC. Doesn't make sense
```{r}
data.frame(date, i_opt_drug, i_si_drug) %>% 
  ggplot() +
  geom_line(aes(x = date, y = min_I_opt, color = "opt")) +
  geom_line(aes(x = date, y = min_I_si, color = "si")) +
  xlim(10, 16) +
  ylim(0,100) +
  theme_bw()

data.frame(date, i_opt_drug, i_si_drug) %>% 
  ggplot() +
  geom_line(aes(x = date, y = max_I_opt, color = "opt")) +
  geom_line(aes(x = date, y = max_I_si, color = "si")) +
  xlim(10, 16) +
  theme_bw()

data.frame(date, i_opt_drug) %>% 
  ggplot() +
  geom_line(aes(x = date, y = min_I_opt, color = "opt")) +
  xlim(10, 16) +
  ylim(0,200) +
  theme_bw()
```

# fitness lol
```{r}
# optimal
tau_cum_opt_drug <- rbind(
  lag_si_I_20.dyn_tsukushi_pyr10_2 %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_4 %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_6 %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_8 %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_10 %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_12 %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_14 %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_16 %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value))
  )

tau_cum_si_drug <- rbind(
  lag_si_I_20.dyn_tsukushi_pyr10_2_si %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_4_si %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_6_si %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_8_si %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),
  
  lag_si_I_20.dyn_tsukushi_pyr10_10_si %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_12_si %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_14_si %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value)),

  lag_si_I_20.dyn_tsukushi_pyr10_16_si %>% 
  dplyr::filter(variable == "tau_cum") %>% 
  dplyr::summarise(max_tau = max(value))
  )

tau_cum_opt_drug

tau_cum_si_drug
```

#-----------------------_#
# smoothing derivatives
#--------------------------#
# smoothing action for alpha day. Inspired by NCC and SCC exp in Revisiting the initial steps of sexual development in the malaria parasite Plasmodium falciparum.
# more accurate is have latter part of iRBC development for NCC cycle. But that just complicates stuff. Assume that parasite makes decision until day of burst (based on average cue during that time!)
```{r}
# coinfection dynamics for reference
lag_ci_I_20.dyn_tsukushi_I <- chabaudi_si_opt_lag(par = c(360.3151, -470.3701, -325.4047, -371.3250),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 0,
                             admin = 0)

# I
lag_ci_I_20.dyn_tsukushi_I %>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::mutate(deriv_est = value-dplyr::lag(value, 1000)) %>% 
  ggplot() +
  geom_line(aes(x = time, y = deriv_est, color = "1 day smooth")) +
  #geom_line(data = lag_ci_I_20.dyn_tsukushi_I %>% dplyr::filter(variable == "I") %>% dplyr::mutate(deriv_est = value-dplyr::lag(value)), aes(x = time, y = deriv_est, color = "no smooth")) +
  theme_bw()

# G
lag_ci_I_20.dyn_tsukushi_I %>% 
  dplyr::filter(variable == "G") %>% 
  dplyr::mutate(deriv_est = value-dplyr::lag(value)) %>% 
  dplyr::mutate(mean_deriv = zoo::rollmean(deriv_est, 1000, fill = NA)) %>% 
  ggplot() +
  geom_line(aes(x = time, y = mean_deriv, color = "1 day smooth")) +
  #geom_line(data = lag_ci_I_20.dyn_tsukushi_I %>% dplyr::filter(variable == "G") %>% dplyr::mutate(deriv_est = value-dplyr::lag(value)), aes(x = time, y = deriv_est, color = "no smooth")) +
  theme_bw()

# M is not very smooth
lag_ci_I_20.dyn_tsukushi_I %>% 
  dplyr::filter(variable == "M" | variable == "Mg") %>% 
  dplyr::group_by(time) %>% 
  dplyr::summarise(value = sum(value)) %>% 
  dplyr::mutate(deriv_est = value-dplyr::lag(value, 1000)) %>% 
  ggplot() +
  geom_line(aes(x = time, y = mean_deriv, color = "1 day smooth")) +
  #geom_line(data = lag_ci_I_20.dyn_tsukushi_I %>% dplyr::filter(variable == "M") %>% dplyr::mutate(deriv_est = value-dplyr::lag(value)), aes(x = time, y = deriv_est, color = "no smooth")) +
  theme_bw()
```

# trying out new smooth ass. Looks good!
```{r}
source(here("functions/test.R"))

# original non smoothed
lag_si_I_20.dyn_tsukushi_pyr10_11_dI <- chabaudi_si_opt_lag(par = c(19.95631,  102.18622, -99.14671 ,-158.16532),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 30, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = seq(-2*10^6, 2*10^6, by = (4*10^6)/5000), 
                             solver = "vode",
                             dyn = TRUE,
                             drug = 10,
                             lag_deriv = TRUE,
                             admin = 11)

# smoothed
lag_si_I_20.dyn_tsukushi_pyr10_11_dI_sm <- chabaudi_si_opt_lag2(par = rep(0.5,4),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 30, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = seq(-2*10^6, 2*10^6, by = (4*10^6)/5000), 
                             solver = "vode",
                             dyn = TRUE,
                             drug = 10,
                             lag_deriv = TRUE,
                             admin = 11,
                             lag_smooth = 1)

ggplot() +
  geom_line(data = lag_si_I_20.dyn_tsukushi_pyr10_11_dI,
            aes(x = time, y = value, color = "no smooth")) +
  facet_wrap(~variable, scales = "free") +
  geom_line(data = lag_si_I_20.dyn_tsukushi_pyr10_11_dI_sm,
            aes(x = time, y = value, color = "smoothed")) +
  facet_wrap(~variable, scales = "free") +
  theme_bw()
```

# optimize based on smoothed deriv
```{r}
# dI
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_tsukushi_pyr10_11_dI_sm <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_lag2, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "tsukushi",
                 parameters = parameters_tsukushi,
                 time_range = seq(0, 25, 1e-3),
                 df = 3,
                 cue = "I",
                 cue_range = seq(-2*10^5, 2*10^5, by = (4*10^5)/5000),
                 solver = "vode",
                 drug = 10,
                 admin = 11,
                 lag_deriv = TRUE,
                 lag_smooth = 1)
stopCluster(cl)
#-5*10^5 both ways
#8.05255 711.422 -463.665 -744.768 
#7.065314 

# 2*10^5 both ways
#-4.821163  117.866646  -45.904221 -152.197128
#6.961954 (lower????)

# for 25 days
#-44.6714 347.565 -180.754 -93.9606  (very different)
#-4.121597 

lag_si_I_20.dyn_tsukushi_pyr10_11_dI_sm <- chabaudi_si_opt_lag2(par = c(-4.821163 , 117.866646 , -45.904221, -152.197128),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 30, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = seq(-2*10^5, 2*10^5, by = (4*10^5)/5000), 
                             solver = "vode",
                             dyn = TRUE,
                             drug = 10,
                             lag_deriv = TRUE,
                             admin = 11,
                             lag_smooth = 1)

# dR
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_tsukushi_pyr10_11_dR_sm <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_lag2, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "tsukushi",
                 parameters = parameters_tsukushi,
                 time_range = seq(0, 25, 1e-3),
                 df = 3,
                 cue = "R",
                 cue_range = seq(-5*10^5, 5*10^5, by = (1*10^6)/5000),
                 solver = "vode",
                 drug = 10,
                 admin = 11,
                 lag_deriv = TRUE,
                 lag_smooth = 1)
stopCluster(cl)
lag_si_I_20.opt_tsukushi_pyr10_11_dR_sm 
# not converged
#-7.278607  17.813993 -15.549947  59.188458
#6.529087

# 25 days
#4.63855 -17.8635 6.59101 4.28949 
#3.81572


ggplot() +
  geom_line(data = lag_si_I_20.dyn_tsukushi_pyr10_11_dI_sm,
            aes(x = time, y = value, color = "smoothed")) +
  geom_line(data = lag_si_I_20.dyn_tsukushi_pyr10_11_dI,
            aes(x = time, y = value, color = "not smoothed")) +
  facet_wrap(~variable, scales = "free") +
  theme_bw()

ggplot() +
  geom_line(data = par_to_df(c(-4.821163 , 117.866646 , -45.904221, -152.197128),seq(-2*10^5, 2*10^5, by = (4*10^5)/5000)), 
            aes(x = cue_range, y = cr)) +
  geom_rug(data =  lag_si_I_20.dyn_tsukushi_pyr10_11_dI %>% 
              dplyr::filter(variable == "I") %>% 
              dplyr::mutate(deriv_sm = value - dplyr::lag(value, 1000)),
            aes(x = deriv_sm)) +
  theme_bw()


lag_si_I_20.dyn_tsukushi_pyr10_11_dI_sm%>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 11) %>% 
  dplyr::filter(time < 11+3.557-2.586/(1+exp(-8.821+11))) %>% 
  dplyr::summarise(max = max(value), min = min(value))


lag_si_I_20.dyn_tsukushi_pyr10_11_dI%>% 
  dplyr::filter(variable == "I") %>% 
  dplyr::filter(time > 11) %>% 
  dplyr::filter(time < 11+3.557-2.586/(1+exp(-8.821+11))) %>% 
  dplyr::summarise(max = max(value), min = min(value))
```

# lets try the usual dates for dI
```{r}
# day 10
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_tsukushi_pyr10_10_dI_sm <- optimParallel(par = c(14.98309,  26.26589, -58.71221, -11.62738),# new parameter search space
                      fn = chabaudi_si_opt_lag2, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "tsukushi",
                 parameters = parameters_tsukushi,
                 time_range = seq(0, 25, 1e-3),
                 df = 3,
                 cue = "I",
                 cue_range = seq(-2*10^5, 2*10^5, by = (2*10^5)/5000),
                 solver = "vode",
                 drug = 10,
                 admin = 10,
                 lag_deriv = TRUE,
                 lag_smooth = 1)
stopCluster(cl)

lag_si_I_20.opt_tsukushi_pyr10_10_dI_sm
# did not converge
#14.98309  26.26589 -58.71221 -11.62738
#7.110823

# converged
#14.98594  26.26465 -58.72604 -11.62740
#7.11092

# 25 days
#15.4103 26.6701 -59.5447 -12.5343 
#3.85894

# day 12
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_tsukushi_pyr10_12_dI_sm <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_lag2, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "tsukushi",
                 parameters = parameters_tsukushi,
                 time_range = seq(0, 25, 1e-3),
                 df = 3,
                 cue = "I",
                 cue_range = seq(-2*10^5, 2*10^5, by = (2*10^5)/5000),
                 solver = "vode",
                 drug = 10,
                 admin = 12,
                 lag_deriv = TRUE,
                 lag_smooth = 1)
stopCluster(cl)

# converged
#3.682657   91.394549  -56.832510 -114.983636
#6.432847

#25 days
#6.15305 349.058 -137.804 -495.12 
#4.64994

# day 14
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_tsukushi_pyr10_14_dI_sm <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_lag2, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "tsukushi",
                 parameters = parameters_tsukushi,
                 time_range = seq(0, 25, 1e-3),
                 df = 3,
                 cue = "I",
                 cue_range = seq(-2*10^5, 2*10^5, by = (2*10^5)/5000),
                 solver = "vode",
                 drug = 10,
                 admin = 14,
                 lag_deriv = TRUE,
                 lag_smooth = 1)
stopCluster(cl)

lag_si_I_20.opt_tsukushi_pyr10_14_dI_sm 
# did not converge
#-6.092535  58.285720 -16.080537 -57.922586
# 6.123665

# convergred
#-6.128416  58.278709 -16.090524 -57.917853
#6.123799

# 25 days. did not converge
#13.60359  51.42588 -61.40317 -54.58754
#6.129963

# day 16
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_tsukushi_pyr10_16_dI_sm <- optimParallel(par = c(-3.122678 , 42.045757,  -8.831504, -61.130974),# new parameter search space
                      fn = chabaudi_si_opt_lag2, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "tsukushi",
                 parameters = parameters_tsukushi,
                 time_range = seq(0, 25, 1e-3),
                 df = 3,
                 cue = "I",
                 cue_range = seq(-2*10^5, 2*10^5, by = (2*10^5)/5000),
                 solver = "vode",
                 drug = 10,
                 admin = 16,
                 lag_deriv = TRUE,
                 lag_smooth = 1)
stopCluster(cl)

lag_si_I_20.opt_tsukushi_pyr10_16_dI_sm
# did not convergre
#-3.122678  42.045757  -8.831504 -61.130974
#7.419513

# converged
#-3.430734  43.943470  -9.036349 -63.364262
#7.425784

# 25 days
#-3.26819 43.2626 -9.1324 -62.4707 
#7.423703 
```

# running dynamics for 30 days
```{r}
lag_si_I_20.dyn_tsukushi_pyr10_10_dI_sm_30 <- chabaudi_si_opt_lag2(par = c(14.98594,  26.26465, -58.72604, -11.62740),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 30, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = seq(-2*10^5, 2*10^5, by = (2*10^5)/5000), 
                             solver = "vode",
                             dyn = TRUE,
                             drug = 10,
                             admin = 10,
                             lag_deriv = TRUE,
                             lag_smooth = 1)

lag_si_I_20.dyn_tsukushi_pyr10_12_dI_sm_30 <- chabaudi_si_opt_lag2(par = c(3.682657,   91.394549,  -56.832510, -114.983636),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 30, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = seq(-2*10^5, 2*10^5, by = (2*10^5)/5000), 
                             solver = "vode",
                             dyn = TRUE,
                             drug = 10,
                             admin = 12,
                             lag_deriv = TRUE,
                             lag_smooth = 1)

lag_si_I_20.dyn_tsukushi_pyr10_14_dI_sm_30 <- chabaudi_si_opt_lag2(par = c(-6.128416,  58.278709, -16.090524, -57.917853),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 30, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = seq(-2*10^5, 2*10^5, by = (2*10^5)/5000), 
                             solver = "vode",
                             dyn = TRUE,
                             drug = 10,
                             admin = 14,
                             lag_deriv = TRUE,
                             lag_smooth = 1)

lag_si_I_20.dyn_tsukushi_pyr10_16_dI_sm_30 <- chabaudi_si_opt_lag2(par = c(-3.430734,  43.943470,  -9.036349, -63.364262),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 30, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = seq(-2*10^5, 2*10^5, by = (2*10^5)/5000), 
                             solver = "vode",
                             dyn = TRUE,
                             drug = 10,
                             admin = 16,
                             lag_deriv = TRUE,
                             lag_smooth = 1)
```

# 25 days dynamic
```{r}
lag_si_I_20.dyn_tsukushi_pyr10_10_dI_sm_25 <- chabaudi_si_opt_lag2(par = c(15.4103, 26.6701, -59.5447, -12.5343 ),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = seq(-2*10^5, 2*10^5, by = (2*10^5)/5000), 
                             solver = "vode",
                             dyn = TRUE,
                             drug = 10,
                             admin = 10,
                             lag_deriv = TRUE,
                             lag_smooth = 1)

lag_si_I_20.dyn_tsukushi_pyr10_12_dI_sm_25 <- chabaudi_si_opt_lag2(par = c(6.15305, 349.058, -137.804, -495.12 ),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = seq(-2*10^5, 2*10^5, by = (2*10^5)/5000), 
                             solver = "vode",
                             dyn = TRUE,
                             drug = 10,
                             admin = 12,
                             lag_deriv = TRUE,
                             lag_smooth = 1)

lag_si_I_20.dyn_tsukushi_pyr10_14_dI_sm_25 <- chabaudi_si_opt_lag2(par = c(13.60359,  51.42588, -61.40317, -54.58754),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = seq(-2*10^5, 2*10^5, by = (2*10^5)/5000), 
                             solver = "vode",
                             dyn = TRUE,
                             drug = 10,
                             admin = 14,
                             lag_deriv = TRUE,
                             lag_smooth = 1)

lag_si_I_20.dyn_tsukushi_pyr10_16_dI_sm_25 <- chabaudi_si_opt_lag2(par = c(-3.26819, 43.2626, -9.1324, -62.4707),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = seq(-2*10^5, 2*10^5, by = (2*10^5)/5000), 
                             solver = "vode",
                             dyn = TRUE,
                             drug = 10,
                             admin = 16,
                             lag_deriv = TRUE,
                             lag_smooth = 1)
```

# comparing conversion rate between 25 vs 30 days. does ont affect to much
```{r}
fig1a1 <- ggplot() +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_10_dI_sm_25 %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "25 days")) +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_10_dI_sm_30 %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "30 days")) +
  labs(color = "", y = "CR") +
  ggtitle("Day 10 administration") +
  theme_bw()

fig1a2 <-ggplot() +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_12_dI_sm_25 %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "25 days")) +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_12_dI_sm_30 %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "30 days")) +
  labs(color = "", y = "CR") +
  ggtitle("Day 12 administration") +
  theme_bw()

fig1a3 <-ggplot() +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_14_dI_sm_25 %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "25 days")) +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_14_dI_sm_30 %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "30 days")) +
  labs(color = "", y = "CR") +
  ggtitle("Day 14 administration") +
  theme_bw()

fig1a4 <-ggplot() +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_16_dI_sm_25 %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "25 days")) +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_16_dI_sm_30 %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "30 days")) +
  labs(color = "", y = "CR") +
  ggtitle("Day 16 administration") +
  theme_bw()

fig1a <- ggarrange(fig1a1, fig1a2, fig1a3, fig1a4, ncol = 2, nrow = 2, align = "hv", common.legend = TRUE)

fig1a
```

# compare dI vs I vs I si (day 25 optimization)
```{r}
# compare fitness
date <- c(10, 12, 14, 16)
fitness_I_opt <- c(3.986848, 4.628525, 6.153198, 7.513432)
fitness_I_si <- c(3.230103, 4.398500, 5.97139, 7.419609)
fitness_dI_opt <- c(3.858943, 4.649938, 6.129962, 7.423686)

# compare iRBC count. max before drug administration, min during drug period
mI_I_opt <- c(106675.3,68755.01,62860.85,54122.42)
lI_I_opt <- c(31.30568,4.056593	,2.398208,1.650925)

mI_I_si <- c(43841.27,57536.24,67624.21,68411.46)
lI_I_si <- c(7.047382,5.748045,4.221308,2.754212)

mI_dI_opt <- c(65451.95,103639.9,107172.9,107307.5)
lI_dI_opt <- c(40.3461,25.09517	,15.8511,10.73172)


# compare Ig count
mIg_I_opt <- c(55425.51,132611.5,102163.6,80364.48)
lIg_I_opt <- c(9.886761,0.0007826804,0.0001208751,8.853655e-06)

mIg_I_si <- c(95416.58,104429,99606.79,86815.95)
lIg_I_si <- c(0.2405274,0.02065461,	0.00646468,0.001689542)

mIg_dI_opt <- c(125666.5,124261.7,96401.58,74178.26)
lIg_dI_opt <- c(7.446858e-05,-4.641898e-05,1.147336e-07,1.105877e-05)

# immune system after drug
NW_I_opt <- c(0.1882144,0.3780227	,0.4480442	,0.4794603)
NW_I_si <- c(0.1712567,0.2657501	,0.3545000	,0.4290384	)
NW_dI_opt <- c(0.2189813,0.3689684,0.4420810,0.4943945)


I_dI.df <- data.frame(date, fitness_I_opt, fitness_I_si, fitness_dI_opt, 
           mI_I_opt, mI_I_si, mI_dI_opt,
           lI_I_opt, lI_I_si, lI_dI_opt,
           mIg_I_opt, mIg_I_si, mIg_dI_opt,
           lIg_I_opt,lIg_I_si, lIg_dI_opt,
           NW_I_opt, NW_I_si, NW_dI_opt)

fig1b1 <- ggplot() +
  geom_line(data = I_dI.df, aes(x = date, y = fitness_I_opt, color = "I")) +
  geom_line(data = I_dI.df, aes(x = date, y = fitness_I_si, color = "I si")) +
  geom_line(data = I_dI.df, aes(x = date, y = fitness_dI_opt, color = "dI")) +
  labs(x = "Date of drug administration", y = "Fitness", color = "Cue") +
  theme_bw()

fig1b2 <- ggplot() +
  geom_line(data = I_dI.df, aes(x = date, y = mI_I_opt, color = "I")) +
  geom_line(data = I_dI.df, aes(x = date, y = mI_I_si, color = "I si")) +
  geom_line(data = I_dI.df, aes(x = date, y = mI_dI_opt, color = "dI")) +
  labs(x = "Date of drug administration", y = "iRBC density before drug", color = "Cue") +
  theme_bw()

fig1b3 <- ggplot() +
  geom_line(data = I_dI.df, aes(x = date, y = lI_I_opt, color = "I")) +
  geom_line(data = I_dI.df, aes(x = date, y = lI_I_si, color = "I si")) +
  geom_line(data = I_dI.df, aes(x = date, y = lI_dI_opt, color = "dI")) +
  labs(x = "Date of drug administration", y = "iRBC density after drug", color = "Cue") +
  theme_bw()

fig1b4 <- ggplot() +
  geom_line(data = I_dI.df, aes(x = date, y = NW_I_opt, color = "I")) +
  geom_line(data = I_dI.df, aes(x = date, y = NW_I_si, color = "I si")) +
  geom_line(data = I_dI.df, aes(x = date, y = NW_dI_opt, color = "dI")) +
  labs(x = "Date of drug administration", y = "N+W", color = "Cue") +
  theme_bw()

fig1b <- ggarrange(fig1b1, fig1b2, fig1b3, fig1b4, align = "hv", ncol=2, nrow = 2,
                   common.legend = TRUE)
fig1b
```

# conversion rate strategy
```{r}
# day 12
lag_si_I_20.par_tsukushi_pyr10_12 <- par_to_df(par =c(4.2893474 ,  3.6860976, -13.0873430,   0.8359934),I_range_mid4_log10)

lag_si_I_20.par_tsukushi_pyr10_12_si <- par_to_df(par =c(5.511734, 2.394041,-17.890312,4.598348),I_range_mid4_log10)

lag_si_I_20.par_tsukushi_pyr10_12_dI_sm <- par_to_df(c(6.15305, 349.058, -137.804, -495.12 ), seq(-2*10^5, 2*10^5, by = (2*10^5)/5000)) 

# day 16
lag_si_I_20.par_tsukushi_pyr10_16 <- par_to_df(par =c(5.416104,   2.763324, -16.706358,   2.931262),I_range_mid4_log10)

lag_si_I_20.par_tsukushi_pyr10_16_dI_sm <- par_to_df(c(-3.26819, 43.2626, -9.1324, -62.4707), seq(-2*10^5, 2*10^5, by = (2*10^5)/5000)) 

# day 12
fig1c1 <- ggplot() +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_12 %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "I opt")) +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_12_dI_sm_25 %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "dI (smoothed)")) +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_12_si %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "I si")) +
  labs(color = "Cue", x = "Days post-invasion", y = "Conversion rate") +
  geom_vline(xintercept = 12) +
  geom_vline(xintercept = 12+1+3.557-2.586/(1+exp(-8.821+10))) +
  ggtitle("Day 12 administration") +
  theme_bw()

# day 16
fig1c2 <- ggplot() +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_16 %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "I opt")) +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_16_dI_sm_25 %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "dI (smoothed)")) +
  geom_line(data = 
              lag_si_I_20.dyn_tsukushi_pyr10_16_si %>% dplyr::filter(variable == "cr"),
            aes(x = time, y = value, color = "I si")) +
  labs(color = "Cue", x = "Days post-invasion", y = "Conversion rate") +
  geom_vline(xintercept = 16) +
  geom_vline(xintercept = 16+1+3.557-2.586/(1+exp(-8.821+10))) +
  ggtitle("Day 16 administration") +
  theme_bw()

fig1c <- ggarrange(fig1c1, fig1c2,  ncol = 2, common.legend = TRUE)

```

#put together
```{r}
fig1ab <- ggarrange(fig1a, fig1b, labels = c("A", "B"))
fig1 <- ggarrange(fig1ab, fig1c, nrow = 2, labels = c("", "C"))

ggsave(here("figures/report7/drug_states.png"), width = 12, height = 10)


```


#------------------------------#
# Explore dual axis cue
#------------------------------#

# to use I or I+Ig
```{r}
# do they correlate?
## get ci and si infection dynamics
lag_ci_I_20.dyn_tsukushi_I <- chabaudi_si_opt_lag(par = c(360.3151, -470.3701, -325.4047, -371.3250),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 0,
                             admin = 0)

lag_si_I_20.dyn_tsukushi_pyr10_0 <- chabaudi_si_opt_lag(par = c(5.511734, 2.394041,-17.890312,4.598348),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 3,
                             cue = "I",
                             cue_range = I_range_mid4_log10, 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE,
                             drug = 0,
                             admin = 0)


# Not perfect but I should do the trick
ggplot() +
  geom_point(data = spread(lag_ci_I_20.dyn_tsukushi_I, variable, value) %>% 
  dplyr::mutate(I_Ig = I+Ig),
            aes(x = I, y = I_Ig, color = time), size = 0.01) +
  viridis::scale_color_viridis() +
  theme_bw()

```

# thinking of spline surface (playing around)
```{r}
library(splines2)
library(fields)
library(MBA)

# define cue range. Might need 
cue_range1 <- seq(0,10^5, by =10^5/100)
cue_range2 <- seq(0,5,by = 5/100)

# get grid for cue range. rename
cr_grid <- expand.grid(cue_range1, cue_range2)
names(cr_grid) <- c("cue_range1", "cue_range2")

# build model
dummy_y.vals <- rep(0, length(cue_range1)) 
dummy_cr.data <- as.data.frame(cbind(cue_range1, dummy_y.vals))

dummy_cr.mod <- lm(dummy_y.vals ~ splines2::bSpline(x = cue_range1, degree = 3, df = 3)*
                     splines2::bSpline(x = cue_range2, degree = 3, df = 3))

# assign coefficient. Need 10 for df 3
dummy_cr.mod$coefficients <- rep(0.2,10)

# visualize
cr_fit_1 <- exp(-exp(predict(dummy_cr.mod, newdata = cr_grid)))


cr_df <- data.frame(cr_grid, cr_fit_1)
ggplot() +
  geom_tile(data = cr_df, aes(x = cue_range1, y = cue_range2, fill = cr_fit_1))

# get data for cr
cr <- exp(-exp(predict(dummy_cr.mod, newdata = data.frame(cue_range1 = 0, cue_range2 = 1))))[[1]]


# df = 2
dummy_cr.mod2 <- lm(dummy_y.vals ~ splines2::bSpline(x = cue_range1, degree = 2, df = 2)*
                     splines2::bSpline(x = cue_range2, degree = 2, df = 2))

# assign coefficient. Need 7 for df2
dummy_cr.mod2$coefficients <- rep(0.2,7)

exp(-exp(predict(dummy_cr.mod2, newdata = cr_grid)))
sink()
cr_df2 <- data.frame(cr_grid, cr_fit_2)

ggplot() +
  geom_tile(data = cr_df, aes(x = cue_range1, y = cue_range2, fill = cr_fit_1))
ggplot() +
  geom_tile(data = cr_df2, aes(x = cue_range1, y = cue_range2, fill = cr_fit_2))


# make cr into a function
cr <- function(cue1, cue2){
  result <- suppressWarnings(exp(-exp(predict(dummy_cr.mod, newdata = data.frame(cue_range1 = cue1, cue_range2 = cue2))))[[1]])
  return(result)
}

df <- cbind(cue1 = c(1,2,3,4),cue2 = c(1,2,3,4))

apply(df, 2, cr)
mapply(cr,c(1,2,3,4),c(1,2,3,4) )
```

# testing out the new single infection dual cue
```{r}
source(here("functions/test.R"))
test <- chabaudi_si_opt_lag2(parameters_cr = rep(0.5, 7),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 20, 1e-3),
                             df = 2,
                             dual_cue = TRUE,
                             cue = "I",
                             cue_b = "W",
                             cue_range = seq(0, log10(6*10^6), by = log10(6*10^6)/500), 
                             cue_range_b = seq(0, 5, by = 5/500),
                             solver = "vode",
                             log_cue = "log10", 
                             log_cue_b = "none",
                             dyn = TRUE)

test2 <- chabaudi_si_opt_lag2(parameters_cr = rep(0.5, 4),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 20, 1e-3),
                             df = 3,
                             dual_cue = FALSE,
                             cue = "I",
                             cue_range = seq(0, log10(6*10^6), by = log10(6*10^6)/500), 
                             solver = "vode",
                             log_cue = "log10", 
                             dyn = TRUE)

cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_IW_20.opt_tsukushi <- optimParallel(par = rep(0.5, 7),# new parameter search space
                      fn = chabaudi_si_opt_lag2, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "tsukushi",
                 parameters = parameters_tsukushi,
                 time_range = seq(0, 25, 1e-3),
                 df = 2,
                 cue = "I",
                 cue_b = "W",
                 cue_range = I_range_mid4_log10,
                 cue_range_b = seq(0, log10(5), by = log10(5)/5000),
                 solver = "vode",
                 log_cue = "log10",
                 log_cue_b = "none",
                 dual_cue = TRUE)
stopCluster(cl)
# start at 3:30

lag_si_IW_20.opt_tsukushi
# converged with W up to 10
#20.447157 -35.094702 -11.944307   0.500000   0.500000   8.171446  -9.203955
#11.83851

lag_si_IW_20.dyn_tsukushi<- chabaudi_si_opt_lag2(parameters_cr = c(20.447157, -35.094702, -11.944307,   0.500000,   0.500000 ,  8.171446 , -9.203955),
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = seq(0, 25, 1e-3),
                             df = 2,
                             dual_cue = TRUE,
                             cue = "I",
                             cue_b = "W",
                             cue_range = seq(0, log10(6*10^6), by = log10(6*10^6)/5000), 
                             cue_range_b = seq(0, 10, by = 10/5000),
                             solver = "vode",
                             log_cue = "log10", 
                             log_cue_b = "none",
                             dyn = TRUE)

# dual cue vs single cue
fig2a <- ggplot() +
  geom_line(data = lag_si_IW_20.dyn_tsukushi %>% 
              dplyr::filter(variable != "S_new"),
            aes(x = time, y = value, color = "I,W")) +
  geom_line(data = lag_si_I_20.dyn_tsukushi_pyr10_0%>% 
              dplyr::filter(variable != "S_new"),
            aes(x = time, y = value, color = "I si")) +
  facet_wrap(~variable, scales = "free") +
  theme_bw()

# plot out reaction norm
source(here("functions/dual_to_df.R"))

lag_si_IW_20.par_tsukushi <- dual_to_df(
  c(20.447157, -35.094702, -11.944307,   0.500000,   0.500000 ,  8.171446 , -9.203955),
  seq(0, log10(6*10^6), by = log10(6*10^6)/500),
  seq(0, 10, by = 10/500),
  df = 2)

lag_si_I_20.par_tsukushi_pyr10_0 <- par_to_df(c(5.511734, 2.394041,-17.890312,4.598348),
                                             I_range_mid4_log10 )


fig2b1 <- ggplot() +
  geom_tile(data = lag_si_IW_20.par_tsukushi, aes(x = cue_range, y = cue_range_b, fill = cr_fit)) +
  labs(x = "Log10(I)", y = "W", fill = "Conversion rate") +
  theme_bw() +
  theme(legend.position="bottom")

fig2b2 <- ggplot() +
  geom_line(data = lag_si_I_20.par_tsukushi_pyr10_0, aes(x = cue_range, y = cr)) +
  labs(x = "Log10(I)", y = "Conversion rate") +
  theme_bw()

fig2b <- ggarrange(fig2b1, fig2b2, ncol = 1, align = "h")

fig2 <- ggarrange(fig2a, fig2b, ncol = 1, labels = c("A", "B"))
ggsave(here("figures/report7/dual_cue.png"), height = 10, width = 7)

seq(log10(-Inf), log10(5), by= log10(5)/10 )
log10(0.2)
```







