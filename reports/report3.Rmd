---
title: "report3"
output: html_document
---

# Load libraries
```{r}
library(deSolve)
library(splines)
library(optimParallel)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(magrittr)
library(Rcpp)
library(microbenchmark)
library(GA)
```

# Load functions
```{r}
setwd("/Users/avrilwang/Desktop/Project_Plasmodium/functions")
source("par_to_df.R")
source("chabaudi_si_opt_fast.R")
source("chabaudi_si_opt_lag.R")
source("total_parasite.R")
source("chabaudi_ci_opt_lag.R")
```
# define parameters
```{r}
parameters <- c(R1 = 8.5*10^6,
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 4*10^-6,
                alpha = 1, 
                alphag = 2, 
                beta = 10, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1)

parameters_tsukushi <- c(R1 = 8.89*10^6, # slightly higher
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 8*10^-6, # doubled form original
                alpha = 1, 
                alphag = 2, 
                beta = 5.721, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1,
                psin = 16.69234,
                psiw = 0.8431785,
                phin = 0.03520591, 
                phiw = 550.842,
                iota = 2.18*(10^6),
                rho = 0.2627156)

time_range <- seq(0, 20, by = 1e-3)
I_range <- seq(0, 2.18*10^6, by = 1000) 
I_range_large <- seq(0, (3.7*10^5)*(8.5*10^6)/((3.7*10^5)-0.025*(8.5*10^6)), by = 1000) 
I_range_mid <- seq(0, 5*10^6, by = 1000)
I_range_mid2 <- seq(0, 4*10^6, by = 1000)
I_range_mid4 <- seq(0, 6*10^6, by = (6*10^6)/5000)

# logged counterpart
I_range_mid2_log <- seq(0, log(4*10^6), by = log(4*10^6)/5000)
I_range_mid3_log <- seq(0, log(5*10^6), by = log(5*10^6)/5000)
I_range_mid4_log <- seq(0, log(6*10^6), by = log(6*10^6)/5000)
I_range_large_log <- seq(0, log((3.7*10^5)*(8.5*10^6)/((3.7*10^5)-0.025*(8.5*10^6))), by = log((3.7*10^5)*(8.5*10^6)/((3.7*10^5)-0.025*(8.5*10^6)))/10000)
```

#--------------------#
# Effects of logging cues
# Figure 1
#--------------------#

# testing out I+IG
```{r}
# without log
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_i_ig_20.opt <- optimParallel(par = c(0.5,0.5,0.5,0.5),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I+Ig",
                      cue_range = I_range,
                      solver = "vode")
stopCluster(cl)

## didn't converge. Is it due to low I range?
lag_si_i_ig_20.opt$par #1.139503  -19.734505   58.152185 -149.598714
lag_si_i_ig_20.opt$value #10.72106

# try with I_range large. Converged
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_i_ig_20.opt_large <- optimParallel(par = c(0.5,0.5,0.5,0.5),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I+Ig",
                      cue_range = I_range_large,
                      solver = "vode")
stopCluster(cl)
lag_si_i_ig_20.opt_large$par #0.6110871 -37.8530875 352.8262597  28.2507776
lag_si_i_ig_20.opt_large$value #10.03784 *not as large but still converged

# repeat with mid I range 
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_i_ig_20.opt_mid <- optimParallel(par = c(0.7205704, -11.9927752,  18.7389358,   7.0955049),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I+Ig",
                      cue_range = I_range_mid,
                      solver = "vode")
stopCluster(cl)
 # did not converge first time
lag_si_i_ig_20.opt_mid$par #0.7205704 -11.9927752  18.7389358   7.0955049
lag_si_i_ig_20.opt_mid$value #10.19125

# repeat with mid I range 2
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_Ig_20.opt_mid2 <- optimParallel(par = c(0.5,0.5,0.5,0.5),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I+Ig",
                      cue_range = I_range_mid2,
                      solver = "vode")
stopCluster(cl)

# converged
lag_si_I_Ig_20.opt_mid2$par #1.13936  -26.87043  134.66369 -565.44822
lag_si_I_Ig_20.opt_mid2$value #10.66155

lag_si_I_Ig_20.dyn_i_mid2 <- chabaudi_si_opt_lag(
  parameters_cr = c(1.13936, -26.87043, 134.66369, -565.44822),
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "I+Ig",
  cue_range = I_range_mid2,
  solver = "vode",
  dyn = TRUE)

# repeat with mid4 range to match minimum range that ran for the logged sample
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_Ig_20.opt_mid4 <- optimParallel(par = c(0.6974646, -13.8881851,  29.3901588,  10.3551182),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I+Ig",
                      cue_range = I_range_mid4,
                      solver = "vode")
stopCluster(cl)

# did not converge. Converged after inserting it the second time???
lag_si_I_Ig_20.opt_mid4$par #0.6974646 -13.8881851  29.3901588  10.3551182
lag_si_I_Ig_20.opt_mid4$value #10.15578

lag_si_I_Ig_20.dyn_i_mid4 <- chabaudi_si_opt_lag(
  parameters_cr = c(0.6974646, -13.8881851,  29.3901588,  10.3551182),
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "I+Ig",
  cue_range = I_range_mid4,
  solver = "vode",
  dyn = TRUE)

lag_si_I_Ig_20.cr_i_mid4 <- par_to_df(c(0.6974646, -13.8881851,  29.3901588,  10.3551182), I_range_mid4)
```

# log
## logging only I. Very little diffefrence with I+Ig optimal model. 
```{r}
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_mid2_log <- optimParallel(par = c(0.5,0.5,0.5,0.5),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range_mid2_log,
                      solver = "vode",
                      log_cue = TRUE)
stopCluster(cl)

# converged
lag_si_I_20.opt_mid2_log$par #53.38506 -74.63229 -46.80107 -56.33301
lag_si_I_20.opt_mid2_log$value # 11.52049

lag_si_I_20.dyn_i_mid2_log <- chabaudi_si_opt_lag(
  parameters_cr = c(53.38506, -74.63229, -46.80107, -56.33301),
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "I",
  cue_range = I_range_mid2_log,
  solver = "vode",
  dyn = TRUE,
  log_cue = TRUE)
```

# retrying logging I+IG
## stuck in iteration 1 when using I_range_mid2_log
```{r}
# is it problem with cue_range?
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_Ig_20.opt_log_large <- optimParallel(par = c(0.5,0.5,0.5,0.5),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I+Ig",
                      cue_range = I_range_large_log,
                      solver = "vode",
                      log_cue = TRUE)
stopCluster(cl)

# converged
lag_si_I_Ig_20.opt_log_large$par #38.67440 -56.97096 -32.27843 -41.80728
lag_si_I_Ig_20.opt_log_large$value #11.51344

# infection dynamics
lag_si_I_Ig_20.dyn_log_large <- chabaudi_si_opt_lag(
  parameters_cr = c(38.67440, -56.97096, -32.27843, -41.80728),
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "I+Ig",
  cue_range = I_range_large_log,
  solver = "vode",
  dyn = TRUE,
  log_cue = TRUE)

# retry again with shorter cue range 
## 5*10^6 max. doesn't run until 1 it
## 6*10^6 max. runs!
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_Ig_20.opt_log_mid4 <- optimParallel(par = c(0.5,0.5,0.5,0.5),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I+Ig",
                      cue_range = I_range_mid4_log,
                      solver = "vode",
                      log_cue = TRUE)
stopCluster(cl)

# converged
lag_si_I_Ig_20.opt_log_mid4$par #38.39625 -52.48414 -35.16696 -39.95028
lag_si_I_Ig_20.opt_log_mid4$value #11.51343 (very little difference). Any way, very high nontheless!
## much higher than #10.88715, which is the standard fitness for infected asexual RBC with 2.18*10^6

# infection dynamics
lag_si_I_Ig_20.dyn_log_mid4 <- chabaudi_si_opt_lag(
  parameters_cr = c(38.39625, -52.48414, -35.16696, -39.95028),
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "I+Ig",
  cue_range = I_range_mid4_log,
  solver = "vode",
  dyn = TRUE,
  log_cue = TRUE)

# cr
lag_si_I_Ig_20.cr_log_mid4 <- par_to_df(c(38.39625, -52.48414, -35.16696, -39.95028), I_range_mid4_log)
```
# plot
```{r}

# infection dynamics. All 6*10^6 max RBC with saturating immunity
fig1A <- ggplot() +
  geom_line(data = total_parasite(lag_si_I_Ig_20.dyn_i_mid4), aes(x = time, y = value, color = "I+Ig")) +
  geom_line(data = total_parasite(lag_si_I_Ig_20.dyn_log_mid4), aes(x = time, y = value, color = "Log(I+Ig)")) +
  facet_wrap(~variable, scales = "free", ncol = 4) +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "") +
  theme_bw() +
  theme(legend.position="bottom")

# cr at log scale
ggplot() +
  geom_line(data = lag_si_I_Ig_20.cr_i_mid4, aes(x = log(cue_range), y = cr, color = "I+Ig")) +
  geom_line(data = lag_si_I_Ig_20.cr_log_mid4, aes(x = cue_range, y = cr, color = "Log(I+Ig)")) +
  labs(x = "Total infected RBC density",
         y = "Conversion rate",
         color = "") +
  theme_bw() +
  theme(legend.position="bottom") 

# cr at normal scale
fig1B <- ggplot() +
  geom_line(data = lag_si_I_Ig_20.cr_i_mid4, aes(x = cue_range, y = cr, color = "I+Ig")) +
  geom_line(data = lag_si_I_Ig_20.cr_log_mid4, aes(x = exp(cue_range), y = cr, color = "Log(I+Ig)")) +
  labs(x = "Total infected RBC density",
         y = "Conversion rate",
         color = "") +
  theme_bw() +
  theme(legend.position="bottom") 

ggarrange(fig1A, fig1B, align = "hv", labels = c("A", "B"), common.legend = TRUE)
setwd("/Users/avrilwang/Desktop/Project_Plasmodium/figures/report3")
ggsave("log_cue.png", width = 15, height = 7)
```

#--------------------#
# Co-infection models
# Figure 2
#--------------------#
# just trying some random parameters
```{r}
lag_ci_I_20.dyn_log_mid4 <- chabaudi_ci_opt_lag(
  parameters_cr_1 = c(0.5, 0.5, 0.5, 0.5),
  parameters_cr_2 = c(0.9060127,  -55.3933591, 1065.6352372,   31.4803195),
  immunity = "tsukushi",
  parameters = parameters_tsukushi,
  time_range = time_range,
  df = 3,
  cue = "I1+I2",
  cue_range = I_range_mid4_log,
  solver = "vode",
  dyn = TRUE,
  log_cue = TRUE)

ggplot() +
  geom_line(data = lag_ci_I_20.dyn_log_mid4, aes(x = time, y = value, color = strain)) +
  facet_wrap(~variable_alt, scales = "free", ncol = 4) +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "") +
  theme_bw() +
  theme(legend.position="bottom")

```

# testing simple optimization scenario. One round
# does improve stuff!
```{r}
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
test <- optimParallel(par = c(0.5,0.5,0.5,0.5),# new parameter search space
                      fn = chabaudi_ci_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      parameters_cr_2 = c(0.5,0.5,0.5,0.5),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I1+I2",
                      cue_range = I_range_mid4_log,
                      solver = "vode",
                      log_cue = TRUE)
stopCluster(cl)

test$par # 63.28413 -79.99912 -58.34953 -64.15034
test$value #3.574704

test.dyn <- chabaudi_ci_opt_lag(
  parameters_cr_1 = test$par,
  parameters_cr_2 = c(0.5, 0.5, 0.5, 0.5),
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "I1+I2",
  cue_range = I_range_mid4_log,
  solver = "vode",
  dyn = TRUE,
  log_cue = TRUE)
```

# let's get serious. Test out pure I-based model with tsukushi model of immunity
## logged as well!
```{r}
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_ci_I_20.opt_log_tsukushi <- co_infection_opt(parameters_cr = rep(0.5, 4),
                 limit = 0.01, 
                 model = chabaudi_ci_opt_lag,
                 immunity = "tsukushi",
                 parameters = parameters_tsukushi,
                 time_range = time_range,
                 df = 3,
                 cue = "I1+I2",
                 cue_range = I_range_mid4_log,
                 solver = "vode",
                 log_cue = TRUE)
stopCluster(cl)

lag_ci_I_20.opt_log_tsukushi$par #332.4361 -428.8672 -302.7355 -341.7225
lag_ci_I_20.opt_log_tsukushi$value #0.005464009

lag_ci_I_20.cr_log_tsukushi <- par_to_df(c(332.4361, -428.8672, -302.7355, -341.7225), I_range_mid4_log)
```

# single infection dynamics optimization. Check for difference
```{r}
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_log_tsukushi <- optimParallel(par = c(0.5,0.5,0.5,0.5),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "tsukushi",
                      parameters = parameters_tsukushi,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range_mid4_log,
                      solver = "vode",
                      log_cue = TRUE)
stopCluster(cl)

lag_si_I_20.opt_log_tsukushi$par #5.477084   2.396156 -17.806718   4.590146
lag_si_I_20.opt_log_tsukushi$value #9.495
lag_si_I_20.opt_log_tsukushi$convergence #0

lag_si_I_20.cr_log_tsukushi <- par_to_df(c(5.477084, 2.396156, -17.806718, 4.590146), I_range_mid4_log)
```

# compare co-infection and single-infection dynamics
## competing same strain with one another results in normal drop in infected RBC. More realistic simulation of infection dynamics
```{r}
lag_ci_I_20.dyn_log_tsukushi <- chabaudi_ci_opt_lag(
  parameters_cr_1 = c(332.4361, -428.8672, -302.7355, -341.7225), # co-infection best strategy
  parameters_cr_2 = c(332.4361, -428.8672, -302.7355, -341.7225), 
  immunity = "tsukushi",
  parameters = parameters_tsukushi,
  time_range = time_range,
  df = 3,
  cue = "I1+I2",
  cue_range = I_range_mid4_log,
  solver = "vode",
  dyn = TRUE,
  log_cue = TRUE)

lag_ci_si_I_20.dyn_log_tsukushi <- chabaudi_ci_opt_lag(
  parameters_cr_1 = c(332.4361, -428.8672, -302.7355, -341.7225), # co-infection best strategy
  parameters_cr_2 = c(5.477084, 2.396156, -17.806718, 4.590146), # single infection best strategy
  immunity = "tsukushi",
  parameters = parameters_tsukushi,
  time_range = time_range,
  df = 3,
  cue = "I1+I2",
  cue_range = I_range_mid4_log,
  solver = "vode",
  dyn = TRUE,
  log_cue = TRUE)

# much lower convesion rate when both infections are adopting the optimal co-infection dynamics
fig2a <- ggplot() +
  geom_line(data = lag_ci_I_20.dyn_log_tsukushi, aes(x = time, y = value, color = strain)) +
  facet_wrap(~variable_alt, scales = "free", ncol = 4) +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "") +
  theme_bw() +
  theme(legend.position="bottom")

# co-infection vs single infection. Co-infection wins out
fig2b <- ggplot() +
  geom_line(data = lag_ci_si_I_20.dyn_log_tsukushi, aes(x = time, y = value, color = strain)) +
  facet_wrap(~variable_alt, scales = "free", ncol = 4) +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "") +
  theme_bw() +
  theme(legend.position="bottom")

fig2c <- ggplot() +
  geom_line(data = lag_ci_I_20.cr_log_tsukushi, aes(x = exp(cue_range), y = cr, color = "Co-infection")) +
  geom_line(data = lag_si_I_20.cr_log_tsukushi, aes(x = exp(cue_range), y = cr, color = "Single infection")) +
  labs(x = "Log(Asxually-infected RBC density)",
         y = "Conversion rate",
         color = "") +
  theme_bw() +
  theme(legend.position="bottom") 

ggplot() +
  geom_line(data = lag_ci_I_20.cr_log_tsukushi, aes(x = exp(cue_range), y = cr, color = "Co-infection")) +
  geom_line(data = lag_si_I_20.cr_log_tsukushi, aes(x = exp(cue_range), y = cr, color = "Single infection")) +
  labs(x = "Log(Asxually-infected RBC density)",
         y = "Conversion rate",
         color = "") +
  theme_bw() +
  theme(legend.position="bottom") 
```

# trying without log transformation
```{r}
# coinfection model without logged cue. Takes forever to run
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_ci_I_20.opt_tsukushi <- co_infection_opt(parameters_cr = rep(0.5, 4),
                 limit = 0.01, 
                 model = chabaudi_ci_opt_lag,
                 immunity = "tsukushi",
                 parameters = parameters_tsukushi,
                 time_range = time_range,
                 df = 3,
                 cue = "I1+I2",
                 cue_range = I_range_mid4,
                 solver = "vode",
                 log_cue = FALSE)
stopCluster(cl)

# single infection
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_tsukushi <- optimParallel(par = c(0.5,0.5,0.5,0.5),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "tsukushi",
                      parameters = parameters_tsukushi,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range_mid4,
                      solver = "vode",
                      log_cue = FALSE)
stopCluster(cl)
```

# fascinating behaviour with non-logged model. L-BFGS enters a neverending cycle
#-------------------#
Code for creating conversion rate animation
#-------------------#
```{r}
# import in data file filled with parameter from each iteration and fitness difference
setwd("/Users/avrilwang/Desktop/Project_Plasmodium/opt_parm")
lag_si_I_20.opt_tsukushi_cycle <- read.csv("lag_si_I_20.opt_tsukushi_cycle.csv")
lag_si_I_20.opt_tsukushi_cycle <- lag_si_I_20.opt_tsukushi_cycle %>% dplyr::select(-X, -X.1)
lag_si_I_20.opt_tsukushi_cycle$fitness_diff <- lag_si_I_20.opt_tsukushi_cycle$fitness_diff*-1
lag_si_I_20.opt_tsukushi_cycle$index <- seq(1, nrow(lag_si_I_20.opt_tsukushi_cycle), by = 1)


lag_si_I_20.opt_tsukushi_cycle_2 <- gather(lag_si_I_20.opt_tsukushi_cycle, key = parameter, value = value, -index)
lag_si_I_20.opt_tsukushi_cycle_2$value <- as.numeric(lag_si_I_20.opt_tsukushi_cycle_2$value)

# plot parameter fluctuations
fig2d <- ggplot(lag_si_I_20.opt_tsukushi_cycle_2) +
  geom_line(aes(x = index, y = value, color = parameter)) +
  facet_wrap(~parameter, scales = "free", ncol = 3) +
  xlim(15, 51) + # one cycle length
  theme_bw()

# loop to get all conversion rate strategy
#lag_si_I_20.cr_tsukushi_cycle 
# create paralmeter list
get_par <- function(df) {
  par <- c(df[1], df[2], df[3], df[4])
  return(par)
}

par_ls <- apply(lag_si_I_20.opt_tsukushi_cycle[, 1:4], 1, FUN = get_par)

# loop to caculate conversion rate with cue
cue_df_ls <- list()
for(i in 1:nrow(lag_si_I_20.opt_tsukushi_cycle)){
  
  cue_df <- par_to_df(par_ls[, i], I_range_mid4)
  cue_df$index <- rep(i, nrow(cue_df))
  
  cue_df_ls[[i]] <- cue_df
}

cr_df <- do.call(rbind, cue_df_ls)
cr_df
# plot
cue_cycle_plot <- ggplot(cr_df) +
  geom_line(aes(x = cue_range, y = cr, color = index)) +
  labs(x = "Asexually infected RBC", y = "Conversion rate", color = "Iteration") +
  theme_bw()

#Circular motion with strategy (very similar to satuarting immunity with GA)
library(gganimate)
cue_cycle_anim <- cue_cycle_plot + 
  transition_states(index) +
  ease_aes('cubic-in-out') +
  ggtitle('Now showing iteration {closest_state}',
          subtitle = 'Iteration {frame} of {nframes}')

setwd("/Users/avrilwang/Desktop/Project_Plasmodium/figures/report3")
animate(cue_cycle_anim, nframes = 52, renderer = gifski_renderer("co_infection_cr_cycle.gif"))

```


# putting best co-infection dynamics in single infection scenario
```{r}
lag_si_I_20.dyn_log_tsukushi_ci_opt <- chabaudi_si_opt_lag(
  parameters_cr = c(332.4361, -428.8672, -302.7355, -341.7225), # co-infection best strategy
  immunity = "tsukushi",
  parameters = parameters_tsukushi,
  time_range = time_range,
  df = 3,
  cue = "I",
  cue_range = I_range_mid4_log,
  solver = "vode",
  dyn = TRUE,
  log_cue = TRUE)

ggplot() +
  geom_line(data = lag_si_I_20.dyn_log_tsukushi_ci_opt, aes(x = time, y = value)) +
  facet_wrap(~variable, scales = "free", ncol = 4) +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "") +
  theme_bw() +
  theme(legend.position="bottom")
```

# plotting together
```{r}
ggarrange(fig2a, fig2b, fig2c, fig2d, align = "hv", labels = c("A", "B", "C", "D"))
setwd("/Users/avrilwang/Desktop/Project_Plasmodium/figures/report3")
ggsave("co_infection.png", width = 10, height = 7)

```








