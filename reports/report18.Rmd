---
title: "R Notebook"
output: html_notebook
---
```{r}
library(dplyr)
library(ggplot2)
library(here)
library(deSolve)
library(crone)
library(optimParallel)
library(doParallel)
library(doRNG)
library(arrow)
library(stringr)
library(parallel)
library(ggpubr)
```

```{r}
source(here("functions/chabaudi_si_clean.R"))
```

Resolving single infection optimization
Previous attempts at optimization resulted in an infection curve that went unresolved. Here, I cannot get the infection period to resolve. Increasing the infection period causes the infection dynamic of the parasite to become flattened. 
```{r}
time_range <- seq(0, 30, by = 1e-3)
```

```{r}
source(here("functions/par_to_df.R"))
source(here("functions/chabaudi_si_clean.R"))

parameters_tsukushi <- c(R1 = 8.89*10^6, # slightly higher
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 8*10^-6, # doubled form original
                alpha = 1, 
                alphag = 2, 
                beta = 5.721, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1,
                psin = 16.69234,
                psiw = 0.8431785,
                phin = 0.03520591, 
                phiw = 550.842,
                iota = 2.18*(10^6),
                rho = 0.2627156)

```

```{r}
opt_local <- function(
  par, # initial parameter sets
  cue, #
  log,
  cue_range,
  dyn = F
  ){
  # start cluster
  cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
  
  # start optimization LFBGS
  res <- optimParallel(
    par = par,
    fn = chabaudi_si_clean, 
    control = list(trace = 6, fnscale = -1),
    immunity = "tsukushi",
    parameters = parameters_tsukushi,
    time_range = time_range,
    cue = cue,
    log_cue = log,
    cue_range = cue_range,
    solver = "vode")
  
  # close cluster
  stopCluster(cl)
  
  return (res)
}
```

# I non-logged
```{r}
I_loc.op <- opt_local(par = rep(0.5, 4),
                            cue = "I",
                            log = "none",
                            cue_range = seq(0, 6*(10^6), by = (6*(10^6))/5000))

I_loc_20.dyn <- chabaudi_si_clean(parameters_cr = c(0.1135384,  -39.0585154, 1941.9082813,  119.8228980),
                               parameters= parameters_tsukushi,
                               immunity = "tsukushi",
                               time_range = seq(0,25,0.001),
                               cue = "I",
                               log_cue = "none",
                               cue_range = seq(0, 6*(10^6), by = (6*(10^6))/5000),
                               dyn = T)

I_loc_25.dyn <- chabaudi_si_clean(parameters_cr = c(-0.4002295,  3.2517089,  0.6089734,  0.4916482),
                               parameters= parameters_tsukushi,
                               immunity = "tsukushi",
                               time_range = seq(0,25,0.001),
                               cue = "I",
                               log_cue = "none",
                               cue_range = seq(0, 6*(10^6), by = (6*(10^6))/5000),
                               dyn = T)

I_loc_30.dyn <- chabaudi_si_clean(parameters_cr = c(-0.4632307,  -12.7384555, 1898.9561735, -292.2138265),
                               parameters= parameters_tsukushi,
                               immunity = "tsukushi",
                               time_range = seq(0,30,0.001),
                               cue = "I",
                               log_cue = "none",
                               cue_range = seq(0, 6*(10^6), by = (6*(10^6))/5000),
                               dyn = T)

# 20 days optimziation
#0.1135384  -39.0585154 1941.9082813  119.8228980
#8.49777

# 25 days 
#-0.4002295  3.2517089  0.6089734  0.4916482
#9.860488

# 30 days
#-0.4632307  -12.7384555 1898.9561735 -292.2138265
#11.81462

# plotting together, we cannot get the infeciton cycle to resolve. By elongating the infection period, we see a flattening of parasite dynamics that prolongs the infection
ggplot()+ 
  geom_line(data = I_loc_30.dyn, aes(x = time, y = value, color = "30")) +
  geom_line(data = I_loc_25.dyn, aes(x = time, y = value, color = "25")) +
  geom_line(data = I_loc_20.dyn, aes(x = time, y = value, color = "20")) +
  facet_wrap(~variable, scales = "free") +
  theme_bw()
```

# I logged
Still no full resolution even with 30 days, although it is closer to resolution than 20 days optimization. Extending the simulation to 25 days allows the optimum 20 days to fully resolve. Hence, for future purposes, it might be better to optimize based on 20 days for optimal acute infection. However, for simulation go to 30 days to ensure fulll resolution 
```{r}
I_log_loc.op <- opt_local(par = rep(0.5, 4),
                            cue = "I",
                            log = "log10",
                            cue_range = seq(0, log10(6*(10^6)), by = (log10(6*(10^6)))/5000))

# 20 days
#5.463558   2.383948 -17.757281   4.571835
#9.494991

# 30 days
# 3.53672545  -0.03564319 -12.38102999   5.20523629
# 13.27947
I_log_loc_20.dyn <- chabaudi_si_clean(parameters_cr = c(5.463558,   2.383948 ,-17.757281 ,  4.571835),
                               parameters= parameters_tsukushi,
                               immunity = "tsukushi",
                               time_range = seq(0,30,0.001),
                               cue = "I",
                               log_cue = "log10",
                               cue_range = seq(0, log10(6*(10^6)), by = (log10(6*(10^6)))/5000),
                               dyn = T)

I_log_loc_30.dyn <- chabaudi_si_clean(parameters_cr = c(3.53672545,  -0.03564319, -12.38102999,   5.20523629),
                               parameters= parameters_tsukushi,
                               immunity = "tsukushi",
                               time_range = seq(0,30,0.001),
                               cue = "I",
                               log_cue = "log10",
                               cue_range = seq(0, log10(6*(10^6)), by = (log10(6*(10^6)))/5000),
                               dyn = T)

ggplot()+ 
  geom_line(data = I_log_loc_30.dyn, aes(x = time, y = value, color = "30")) +
  geom_line(data = I_log_loc_20.dyn, aes(x = time, y = value, color = "20")) +
  facet_wrap(~variable, scales = "free") +
  theme_bw()
```


#---------------------------------------------------------#
# Co-infection optimization
#---------------------------------------------------------#
```{r}
source(here("functions/par_to_df.R"))
source(here("functions/chabaudi_si_clean.R"))
source(here("functions/chabaudi_ci_clean.R"))
parameters_tsukushi <- c(R1 = 8.89*10^6, # slightly higher
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 8*10^-6, # doubled form original
                alpha = 1, 
                alphag = 2, 
                beta = 5.721, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1,
                psin = 16.69234,
                psiw = 0.8431785,
                phin = 0.03520591, 
                phiw = 550.842,
                iota = 2.18*(10^6),
                rho = 0.2627156)

time_range <- seq(0, 20, by = 1e-3)
```

#---------------------------------#
# confirming coinfection optimal strategy
#---------------------------------#
hard to do global optimization on coinfection optimization. One way to see whether our guesses are good is to compete our optimal conversion rate strategy with a bunch random parameter sets

# processing ci_optidf
```{r}
# import in ci optimum for same cue
ci_opt.df <- read.csv(here("data/ci_opt.csv"))

# reclass for better labels
ci_opt.df <- ci_opt.df %>% 
  mutate(label_1 = case_when(
  cue == "I-i" ~ "Asexual iRBC",
  cue == "I1+I2" ~ "Total asexual\niRBC",
  cue == "Ig-i" ~ "Sexual iRBC",
  cue == "Ig1+Ig2" ~ "Total sexual\niRBC",
  cue == "sum" ~ "Total iRBC",
  cue == "G-i" ~ "Gametocyte",
  cue == "G1+G2" ~ "Total\ngametocyte",
  cue == "R" ~ "RBC"
)) %>% 
  mutate(label_2 = case_when(
    log == "log" ~ "log10",
    log == "none" ~ ""
  )) %>% 
  mutate(label_3 = paste(label_1, label_2),
         id = paste0(cue, "_", log))

# left join with cue range df
cue_range.df <- read.csv(here("data/cue_range.csv"))

ci_opt.df <- ci_opt.df %>% left_join(select(cue_range.df, low, high, by, id), by = c("id" = "id"))
```

# function for checking ci
```{r}
check_ci_opt <- function(df){
  
  # get label
  label <- df$label_3
  
  # cluster initialization
  cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
  registerDoParallel(cl)
  registerDoRNG(137)
  
  res <- foreach(i= 1:1000, .packages = c("doParallel", "doRNG", "deSolve", "splines2", "stringr", "dplyr", "tidyr", "crone", "here")) %dorng% {
  # source function
  source(here("functions/chabaudi_ci_clean.R"))
    
  # parameters 
  parameters_tsukushi <- c(R1 = 8.89*10^6, # slightly higher
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 8*10^-6, # doubled form original
                alpha = 1, 
                alphag = 2, 
                beta = 5.721, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1,
                psin = 16.69234,
                psiw = 0.8431785,
                phin = 0.03520591, 
                phiw = 550.842,
                iota = 2.18*(10^6),
                rho = 0.2627156)
  
  # read in df info
  if(stringr::str_detect(df$cue, "-i")){cue_1 = paste0(gsub("*-i", "", df$cue), "1")}
  if(stringr::str_detect(df$cue, "-i", negate = T)){cue_1 = df$cue}
  if(stringr::str_detect(df$cue, "-i")){cue_2 = paste0(gsub("*-i", "", df$cue), "2")}
  if(stringr::str_detect(df$cue, "-i", negate = T)){cue_2 = df$cue}
  if(stringr::str_detect(df$log, "log")){log_1 = "log10"}
  if(stringr::str_detect(df$log, "none")){log_1 = "none"}
  if(stringr::str_detect(df$log, "log")){log_2 = "log10"}
  if(stringr::str_detect(df$log, "none")){log_2 = "none"}
  par <- c(df$var1, df$var2, df$var3, df$var4)
  cue_range <- seq(df$low, df$high, by = df$by)
  
  # generate random par, bounds for parameters based on previous determined bounds
  par1 <- runif(1, -1, 1)
  par2 <- runif(1, -100, 100)
  par3 <- runif(1, -1000, 10000)
  par4 <- runif(1, -5000, 5000)
  
  par_rand <- c(par1, par2, par3, par4)
  
  # get fitness. 20 days simulation to cut down on computation time
  fitness <- chabaudi_ci_clean(parameters_cr_1 = par,
                  parameters_cr_2 = par_rand,
                  immunity = "tsukushi",
                  parameters = parameters_tsukushi,
                  cue_1 = cue_1,
                  cue_2 = cue_2,
                  cue_range_1 = cue_range,
                  cue_range_2 = cue_range,
                  log_cue_1 = log_1,
                  log_cue_2 = log_2,
                  solver = "vode",
                  time_range = seq(0, 30, by = 1e-3),
                  dyn = F)
  }
  stopCluster(cl)
  
  ## get fitness.df
  fitness.df <- do.call("rbind", res)

  ## rbind
  fitness.df <- as.data.frame(cbind(fitness.df, label = rep(label, nrow(fitness.df))))
  
  return(fitness.df)
}
```

# run confirmatory checks
```{r}
# split into 3 chunks
ci_opt.df1 <- ci_opt.df[1:5,]
ci_opt.df2 <- ci_opt.df[6:10,]
ci_opt.df3 <- ci_opt.df[11:14,]

ci_opt.ls1 <- split(ci_opt.df1, seq(nrow(ci_opt.df1)))
ci_opt.ls2 <- split(ci_opt.df2, seq(nrow(ci_opt.df2)))
ci_opt.ls3 <- split(ci_opt.df3, seq(nrow(ci_opt.df3)))
```


```{r}
# lapply serial iteration
ci_opt.cf1 <- lapply(ci_opt.ls1, check_ci_opt)
ci_opt.res1 <- do.call(rbind, ci_opt.cf1)
write.csv(ci_opt.res1, here("data/ci_opt_cf/ci_opt_res1.csv"), row.names = F)
ci_opt.res1 <- read.csv(here("data/ci_opt_cf/ci_opt_res1.csv"))


# look at  min
ci_opt.res1 %>% group_by(label) %>% summarise(min = min(as.numeric(V1)))

ggplot() +
  geom_histogram(data = ci_opt.res1, aes(x = as.numeric(V1)), bins = 80) +
  facet_wrap(~label, scales = "free_y") +
  geom_vline(xintercept = 0) +
  theme_bw()
```


```{r}
ci_opt.cf2 <- lapply(ci_opt.ls2, check_ci_opt)
ci_opt.res2 <- do.call(rbind, ci_opt.cf2)
write.csv(ci_opt.res2, here("data/ci_opt_cf/ci_opt_res2.csv"), row.names = F)
ci_opt.res2 <- read.csv(here("data/ci_opt_cf/ci_opt_res2.csv"))

ci_opt.res2 %>% group_by(label) %>% summarise(min = min(as.numeric(V1)))
```


```{r}
ci_opt.cf3 <- lapply(ci_opt.ls3, check_ci_opt)
ci_opt.res3 <- do.call(rbind, ci_opt.cf3)
write.csv(ci_opt.res3, here("data/ci_opt_cf/ci_opt_res3.csv"), row.names = F)
ci_opt.res3 <- read.csv(here("data/ci_opt_cf/ci_opt_res3.csv"))
ci_opt.res3 %>% group_by(label) %>% summarise(min = min(as.numeric(V1)))

```

Sexual iRBC log10	
Total gametocyte	
Total sexualiRBC log10
are all cue runs in which we have non optimized strategy
```{r}
ci_opt.res <- rbind(ci_opt.res1, ci_opt.res2, ci_opt.res3)
ci_opt.res %>% group_by(label) %>% summarise(min = min(as.numeric(V1)))
```

#----------------------------------#
# reperform ci optimization for 3 cues
# with unoptimized strategy
#---------------------------------#
Here, I used the the alterative co infection optimizations script that adresses the issue of L-BFGS stuck at local maximum by beginning any optimization run with fitness difference of 0 at 0.5x4. everything run is started with initial strategy found in previous optimization to save time.
```{r}
source(here("functions/co_infection_opt_alt.R"))
time_range <- seq(0, 20, by = 1e-3)
```

# sexual iRBC log10
```{r}
ci_Ig_log_opt <- co_infection_opt_alt(parameters_cr = c(35.6294,	-65.6898,	-11.5609,	-52.0779),
                             limit = 0.01,
                             model = chabaudi_ci_clean,
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = time_range,
                             cue_1 = "Ig1",
                             cue_2 = "Ig2",
                             cue_range_1 = seq(0, log10(6*(10^6)), by = log10(6*(10^6))/5000),
                             cue_range_2 = seq(0, log10(6*(10^6)), by = log10(6*(10^6))/5000),
                             solver = "vode",
                             log_cue_1 = "log10",
                             log_cue_2 = "log10")

ci_Ig_log_opt <- co_infection_opt_do(parameters_cr = rep(0.5,4),
                             limit = 0.01,
                             model = chabaudi_ci_clean,
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = time_range,
                             cue_1 = "Ig1",
                             cue_2 = "Ig2",
                             cue_range_1 = seq(0, log10(6*(10^6)), by = log10(6*(10^6))/5000),
                             cue_range_2 = seq(0, log10(6*(10^6)), by = log10(6*(10^6))/5000),
                             solver = "vode",
                             log_cue_1 = "log10",
                             log_cue_2 = "log10",
                             neg = T)

# 2.189146 -5.450051  4.543525 -9.356682

# do
# -0.419426   96.411807  823.920086 -949.733302 -> cannot compete with local
# 0.874028  -86.583311  340.454528 -369.837694
# 0.631738  -19.086138   68.802929  -97.782339
# 0.950632  -84.510114  352.418519 -545.198396

# testing do vs lbfgs strategy. LBFGS wins everytime
test <- chabaudi_ci_clean(parameters_cr_1 = c(2.189146, -5.450051,  4.543525, -9.356682),
                  parameters_cr_2 = c(0.631738,  -19.086138,   68.802929,  -97.782339),
                  immunity = "tsukushi",
                  parameters = parameters_tsukushi,
                  cue_1 = "Ig1",
                  cue_2 = "Ig2",
                  cue_range_1 = seq(0, log10(6*(10^6)), by = log10(6*(10^6))/5000),
                  cue_range_2 = seq(0, log10(6*(10^6)), by = log10(6*(10^6))/5000),
                  log_cue_1 = "log10",
                  log_cue_2 = "log10",
                  solver = "vode",
                  time_range = seq(0, 30, by = 1e-3),
                  dyn = F)
```

# total gametocyte
```{r}
ci_G1_G2_opt <- co_infection_opt_alt(parameters_cr = c(4.15261,  -6956.90696,    946.10138, -16629.64406 ),
                             limit = 0.01,
                             model = chabaudi_ci_clean,
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = time_range,
                             cue_1 = "G1+G2",
                             cue_2 = "G1+G2",
                             cue_range_1 = seq(0, 6*(10^4), (6*(10^4))/5000),
                             cue_range_2 = seq(0, 6*(10^4), (6*(10^4))/5000),
                             solver = "vode",
                             log_cue_1 = "none",
                             log_cue_2 = "none")

source(here("functions/co_infection_opt_do.R"))
ci_G1_G2_opt <- co_infection_opt_do(parameters_cr = c(1.000000,   -21.024895,  328.757233,-4367.765931),
                             limit = 0.01,
                             model = chabaudi_ci_clean,
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = time_range,
                             cue_1 = "G1+G2",
                             cue_2 = "G1+G2",
                             cue_range_1 = seq(0, 6*(10^4), (6*(10^4))/5000),
                             cue_range_2 = seq(0, 6*(10^4), (6*(10^4))/5000),
                             solver = "vode",
                             log_cue_1 = "none",
                             log_cue_2 = "none",
                             neg = T)

# 4.15261  -6956.90696    946.10138 -16629.64406 
# note has 0 fitness difference. repefrom with 0.5x4 skip out par

# repeated again. did not go to 0 so looks good
# 1.714645  -3188.074319    807.823556 -12906.583435

# did not pass confirmatory check. repeat with do
# first round: 1.000000,   -21.024895,  328.757233,-4367.765931
# second round: 1.000000  -20.662996  324.585014-4999.967412
# 1.000000  -21.911779  338.362460-4999.999660
```

# total sexual iRBC log10
using GA because previous attempts of using Lbfgs still results in local optimum
```{r}
source(here("functions/co_infection_opt_do.R"))
source(here("functions/chabaudi_ci_clean.R"))
ci_Ig1_Ig2_log_opt <- co_infection_opt_do(parameters_cr = c( 0.997924,  -88.047050, -397.592783, 4699.788955),
                             limit = 0.01,
                             model = chabaudi_ci_clean,
                             immunity = "tsukushi",
                             parameters = parameters_tsukushi,
                             time_range = time_range,
                             cue_1 = "Ig1+Ig2",
                             cue_2 = "Ig1+Ig2",
                             cue_range_1 = seq(0, log10(6*(10^6)), by = (log10(6*(10^6)))/5000),
                             cue_range_2 = seq(0, log10(6*(10^6)), by = (log10(6*(10^6)))/5000),
                             solver = "vode",
                             log_cue_1 = "log10",
                             log_cue_2 = "log10",
                             neg = T)

# 0.990252  -88.272781 -362.975537 3833.337160

#  0.713855  -59.665883  164.129039 -163.384715

# 0.997924,  -88.047050, -397.592783, 4699.788955

# 0.963606  -73.245102  211.446322 -182.771856

# repeated -> do not use. probably no global optimum 
```

#-------------------------------#
# repeat validation for stranglers
#------------------------------#
# confirmatory checks for Ig-1 log
```{r}
# import in updated ci_opt df
ci_opt.df <- read.csv(here("data/ci_opt.csv"))

#reclass for better labels
ci_opt.df <- ci_opt.df %>% 
  mutate(label_1 = case_when(
  cue == "I-i" ~ "Asexual iRBC",
  cue == "I1+I2" ~ "Total asexual\niRBC",
  cue == "Ig-i" ~ "Sexual iRBC",
  cue == "Ig1+Ig2" ~ "Total sexual\niRBC",
  cue == "sum" ~ "Total iRBC",
  cue == "G-i" ~ "Gametocyte",
  cue == "G1+G2" ~ "Total\ngametocyte",
  cue == "R" ~ "RBC"
)) %>% 
  mutate(label_2 = case_when(
    log == "log" ~ "log10",
    log == "none" ~ ""
  )) %>% 
  mutate(label_3 = paste(label_1, label_2),
         id = paste0(cue, "_", log))

# left join with cue range df
cue_range.df <- read.csv(here("data/cue_range.csv"))

ci_opt.df <- ci_opt.df %>% left_join(select(cue_range.df, low, high, by, id), by = c("id" = "id"))

# filter  for sexual iRBC log10 and total gamteocyte
ci_opt_Ig.df <- ci_opt.df %>% filter(id == "Ig-i_log")

# split for confirmatory checks
ci_opt_Ig.ls <- split(ci_opt_Ig.df, seq(nrow(ci_opt_Ig.df)))

# run confirmatory checks
ci_opt_Ig.cf <- check_ci_opt(ci_opt_Ig.df)

write.csv(ci_opt_Ig.cf, here("data/ci_opt_cf/ci_opt_res_Ig.csv"), row.names = F)
ci_opt_Ig.res <- read.csv(here("data/ci_opt_cf/ci_opt_res_Ig.csv"))
```

# second confirmation of gametocyte
```{r}
ci_opt_g.df <- ci_opt.df %>% filter(id == "G1+G2_none")

ci_opt_g.res <- check_ci_opt(ci_opt_g.df)
write.csv(ci_opt_g.res, here("data/ci_opt_cf/ci_opt_res_g.csv"), row.names = F)
```


#---------------------------------#
# processing validation data
#---------------------------------#
```{r}
# import in the old validation results (not valid for gametocyte total and Igi log)
ci_opt.res1 <- read.csv(here("data/ci_opt_cf/ci_opt_res1.csv"))
ci_opt.res2 <- read.csv(here("data/ci_opt_cf/ci_opt_res2.csv"))
ci_opt.res3 <- read.csv(here("data/ci_opt_cf/ci_opt_res3.csv"))

# import in the newer vaidation results -> for Igi
ci_opt_Ig.res <- read.csv(here("data/ci_opt_cf/ci_opt_res_Ig.csv"))

# import in the newer validation results -> for gametocyte total
ci_opt_g.res <- read.csv(here("data/ci_opt_cf/ci_opt_res_g.csv"))

# combine old validation data and filter out the wrong ones (those using old parameters)
ci_opt.res123 <- rbind(ci_opt.res1, ci_opt.res2, ci_opt.res3)
ci_opt.res123 <- ci_opt.res123 %>% filter(label != "Sexual iRBC log10" & label != "Total\ngametocyte " & label != "Total sexual\niRBC log10")

# combine!
ci_opt.res <- rbind(ci_opt.res123, ci_opt_Ig.res, ci_opt_g.res)

ci_opt.res %>% filter(V1 <=0) # no records below 0
```

# plot!
```{r}
ggplot() +
  geom_histogram(data = ci_opt.res, aes(x = V1), bins = 80) +
  facet_wrap(~label, scales = "free_y", ncol = 4) +
  geom_vline(xintercept = 0, color = "red") +
  labs(y = "Frequency", x = "Fitness difference") +
  theme_bw()

ggsave(here("figures/report18/ci_opt_cf.png"))
```

#---------------------------------#
# visualization co-infection strategy
#---------------------------------#
for all co-infection, optimized for 20 days. certain cues, I1+I2 and Ig1+Ig2 none-logged exhibit cyclical pattern and is omitted from subsequent analysis

All dynamics is simulated for 30 days to ensure that transmission acrrument is over

# get conversion rate reaction norm
# altering code from report 17 for double strains. 30 days simulated
```{r}
heaviside_trans <- function(cue_range, max){
  res <- crone::heaviside(cue_range)*(cue_range)+(crone::heaviside(cue_range-max)*(max-cue_range))
  return(res)
}

get_dyn <- function(df){
  
  # read in df info
  if(stringr::str_detect(df$cue, "-i")){cue_1 = paste0(gsub("*-i", "", df$cue), "1")}
  if(stringr::str_detect(df$cue, "-i", negate = T)){cue_1 = df$cue}
  if(stringr::str_detect(df$cue, "-i")){cue_2 = paste0(gsub("*-i", "", df$cue), "2")}
  if(stringr::str_detect(df$cue, "-i", negate = T)){cue_2 = df$cue}
  if(stringr::str_detect(df$log, "log")){log_1 = "log10"}
  if(stringr::str_detect(df$log, "none")){log_1 = "none"}
  if(stringr::str_detect(df$log, "log")){log_2 = "log10"}
  if(stringr::str_detect(df$log, "none")){log_2 = "none"}
  par <- c(df$var1, df$var2, df$var3, df$var4)
  cue_range <- seq(df$low, df$high, by = df$by)
  label <- df$label_3
  
  # get dynamics
  dyn <- chabaudi_ci_clean(parameters_cr_1 = par,
                  parameters_cr_2 = par,
                  immunity = "tsukushi",
                  parameters = parameters_tsukushi,
                  cue_1 = cue_1,
                  cue_2 = cue_2,
                  cue_range_1 = cue_range,
                  cue_range_2 = cue_range,
                  log_cue_1 = log_1,
                  log_cue_2 = log_2,
                  solver = "vode",
                  time_range = seq(0, 30, 0.001),
                  dyn = T)
  
    dyn2 <- data.frame(dyn, label = rep(label, nrow(dyn)))

  # get reaction norm
  rn <- par_to_df(par = par, cue_range = cue_range)

  
  # get rug
  ## if + in cue, need to filter out those variables and add together
  if(stringr::str_detect(cue_1, "\\+")){
    cue_split <- stringr::str_split(string = cue_1, pattern = "\\+", simplify = T)
    ## get the two cues 
    cue_temp_1 <- cue_split[[1]]
    cue_temp_2 <- cue_split[[2]]
    
    ## filter dyn
    rug <- dyn2 %>% 
      filter(variable == cue_temp_1 | variable == cue_temp_2) %>% 
      dplyr::group_by(time) %>% 
      dplyr::mutate(sum = sum(value)) %>% 
      select(time, value = sum, label)
  }
  
  ## if sum
  if(cue_1 == "sum"){
    ## filter dyn
    rug <- dyn2 %>% 
      filter(variable == "I1" | variable == "I2" | variable == "Ig1" | variable == "Ig2") %>% 
      dplyr::group_by(time) %>% 
      dplyr::mutate(sum = sum(value)) %>% 
      select(time, value = sum, label)
  }
  
  # for simplified cue
  if(stringr::str_detect(cue_1, "\\+", negate = T) && cue_1 != "sum"){
    rug <- dyn2 %>% 
      dplyr::filter(variable == cue_1) %>% 
      dplyr::select(time, value, label)}
  
  # for logged, backtransform cue range of reaction norm 
  rn2 <- rn
  if(stringr::str_detect(log_1, "log")){rn2$cue_range <- 10^(rn2$cue_range)}

  # append label to reaction norm, dyn, and rug
  rn2 <- data.frame(rn2, label = rep(label, nrow(rn)))

  return(list(dyn2, rn2, rug))
}

```

# loop through df to get reaction norm + dyn
```{r}
# split df 
ci_opt.ls <- split(ci_opt.df, seq(nrow(ci_opt.df)))

# parallelzed lapply
ci_opt.dyn <- mclapply(ci_opt.ls, get_dyn, mc.cores = 6)

# bind together dynamics
dyn.ls <- lapply(ci_opt.dyn, function(x)x[[1]])
ci_dyn.df <- do.call(rbind, dyn.ls)

rn.ls <- lapply(ci_opt.dyn, function(x)x[[2]])
ci_rn.df <- do.call(rbind, rn.ls)

rug.ls <- lapply(ci_opt.dyn, function(x)x[[3]])
ci_rug.df <- do.call(rbind, rug.ls)
```


```{r}
# filter to restriction conversion rate reaction norm range to cue ranges that appear in rug
## change to Inf/-inf to NA
ci_rug_lim.df <- ci_rug.df %>% 
  group_by(label) %>% 
  summarise(min = min(value, na.rm = T)*0.9,
         max = max(value, na.rm = T)*1.1)

# manually change the range for gametocyte total range (0 to 20000)
ci_rug_lim.df[10,3] <- 20000

# filter ci_rn by limit
ci_rn_lim.df <- ci_rn.df %>% 
  left_join(ci_rug_lim.df) %>% 
  group_by(label) %>% 
  filter(cue_range <= max & cue_range >= min)
  
write.csv(ci_rn_lim.df, here("data/ci_dyn/ci_rug_lim.csv"))
write.csv(ci_rug.df, here("data/ci_dyn/ci_rug.csv"))
```

# visualization
```{r}
ggplot() +
  geom_line(data = ci_rn_lim.df, aes(x = cue_range, y = cr)) +
  geom_rug(data = ci_rug.df, aes(x = value), color = "red") +
  facet_wrap(~label, scales = "free_x", ncol = 2) +
  theme_bw() +
  labs(y = "Conversion rate", x = "Cue range") +
  scale_x_continuous(labels = function(x) format(x, scientific = FALSE),
                     guide = guide_axis(check.overlap = TRUE)) + 
                    theme(axis.text.x = element_text(size = 7)) 

ggsave(here("figures/report18/ci_opt_cr.png"), height = 10)
```



#---------------------------------#
Competing co-infection STATIC
#---------------------------------#

fully static run with the optimal parameter for each cue competing against each other. parasites are not allowed to alter their strategy. In biology terms, think of when intrastrain competition>>interstrain competition, thereby maintaining the original optimizal parameters.

```{r}
source(here("functions/chabaudi_ci_clean.R"))
cue_range.df <- read.csv(here("data/cue_range.csv"))
```

# create cue_range df
if _i at end of cue, suggesting of I1/I2 (self-differentation possible).
```{r}
# code. 
cue_range.df <- cbind.data.frame(
  cue = c("I-i", "I-i",
          "I1+I2",
          "Ig-i", "Ig-i",
          "Ig1+Ig2",
          "sum", "sum",
          "G-i", "G-i",
          "G1+G2", "G1+G2",
          "R", "R"),
  log = c("none", "log",
          "log",
          "none", "log",
          "log",
          "none", "log",
          "none", "log",
          "none", "log",
          "none", "log"),
  low = c(0, 0,
          0,
          0, 0,
          0,
          0, 0,
          0, 0,
          0, 0,
          (10^6), log10(10^6)),
  high = c(6*(10^6), log10(6*(10^6)),
           log10(6*(10^6)),
           6*(10^6), log10(6*(10^6)),
           log10(6*(10^6)),
           6*(10^6), log10(6*(10^6)),
           6*(10^4), log10(6*(10^4)),
           6*(10^4), log10(6*(10^4)),
           (10^7), log10(10^7)),
  by = c((6*(10^6))/5000, (log10(6*(10^6)))/5000,
         (log10(6*(10^6)))/5000,
         (6*(10^6))/5000, (log10(6*(10^6)))/5000,
         (log10(6*(10^6)))/5000,
         (6*(10^6))/5000, (log10(6*(10^6)))/5000,
         (6*(10^4))/5000, (log10(6*(10^4)))/5000,
         (6*(10^4))/5000, (log10(6*(10^4)))/5000,
         ((10^7)-(10^6))/5000, (log10(10^7)-log10(10^6))/5000)
) %>% 
  mutate(id = paste0(cue, "_", log))

write.csv(cue_range.df, here("data/cue_range.csv"), row.names = F)
```

# check for time series to get time range. Using isolated asexual iRBC as subject
30 days is insufficient for full infection resolution but very little fitness is accrued at the end
```{r}
ci_I_i.dyn <- chabaudi_ci_clean(parameters_cr_1 = c(381.7701,-528.2317,-324.5508,-403.8235),
                  parameters_cr_2 = c(381.7701,-528.2317,-324.5508,-403.8235),
                  immunity = "tsukushi",
                  parameters = parameters_tsukushi,
                  cue_1 = "I1",
                  cue_2 = "I2",
                  cue_range_1 = seq(0, log10(6*(10^6))),
                  cue_range_2 = seq(0, log10(6*(10^6))),
                  log_cue_1 = "log10",
                  log_cue_2 = "log10",
                  solver = "vode",
                  time_range = seq(0,30,0.001),
                  dyn = T)
ggplot() +
  geom_line(data = test, aes(x = time, y = value, color = strain)) +
  facet_wrap(~variable_alt, scales = "free")+
  theme_bw()
```

# function to loop over strategy dataframe
```{r}
ci_comp_static <- function(df){
  
  # process cue. if detect _i, suggesting individual cue. 
  if(stringr::str_detect(df$cue, "-i")){cue_1 = paste0(gsub("*-i", "", df$cue), "1")}
  if(stringr::str_detect(df$cue, "-i", negate = T)){cue_1 = df$cue}
  
  if(stringr::str_detect(df$cue_2, "-i")){cue_2 = paste0(gsub("*-i", "", df$cue_2), "2")}
  if(stringr::str_detect(df$cue_2, "-i", negate = T)){cue_2 = df$cue_2}
  
  # process log10
  if(stringr::str_detect(df$log, "log")){log_1 = "log10"}
  if(stringr::str_detect(df$log, "none")){log_1 = "none"}
  
  if(stringr::str_detect(df$log_2, "log")){log_2 = "log10"}
  if(stringr::str_detect(df$log_2, "none")){log_2 = "none"}
  
  # get fitness difference between strain and strain 2 
  # simulated fort 30 days for transmission resolution (infectino may not resolve but transmission accumulation has halted)
  # past test suggests very little difference between 20 vs 30 days.
  fitness <- chabaudi_ci_clean(parameters_cr_1 = c(df$var1, df$var2, df$var3, df$var4),
                  parameters_cr_2 = c(df$var1_2, df$var2_2, df$var3_2, df$var4_2),
                  immunity = "tsukushi",
                  parameters = parameters_tsukushi,
                  cue_1 = cue_1,
                  cue_2 = cue_2,
                  cue_range_1 = seq(df$low, df$high, by = df$by),
                  cue_range_2 = seq(df$low_2, df$high_2, by = df$by_2),
                  log_cue_1 = log_1,
                  log_cue_2 = log_2,
                  solver = "vode",
                  time_range = seq(0, 30, 0.001))
  
  # return list
  return(list(df$id, df$id_2, fitness))
}
```


```{r}
# read in table of optimal parameter from co-infection (20 days period), but we will simulate for 30 days for transmission resolution
ci_opt.df <- read.csv(here("data/ci_opt.csv"))

# get unique id and join with cue range df
ci_cue.df <- ci_opt.df %>% 
  mutate(id = paste0(cue, "_", log)) %>% 
  left_join(select(cue_range.df, c(id, low, high, by)), by = c("id" = "id"))

# get all pairwise combinations
ci_cue_pair.df <- ci_cue.df %>% 
  setNames(paste0(names(ci_cue.df), '_2')) %>% 
  tidyr::crossing(ci_cue.df, .name_repair = "check_unique") %>% 
  janitor::clean_names()

# keep only unique pairwise combinations
ci_cue_pair.df2 <- ci_cue_pair.df[!duplicated(apply(select(ci_cue_pair.df, id, id_2), 1, function(x) paste(sort(x),collapse=''))),]

# split to list
ci_cue_pair.ls <- split(ci_cue_pair.df2, seq(nrow(ci_cue_pair.df2)))

# parallelized lapply
ci_comp_static <- mclapply(ci_cue_pair.ls, ci_comp_static)

# process data frame
ci_comp_static.df <- data.frame(do.call(rbind, lapply(ci_comp_static, unlist)))
names(ci_comp_static.df) <- c("id_1", "id_2", "fitness_diff")

# parse id to get cue and log status
ci_comp_static.df <- ci_comp_static.df %>% 
  mutate(
    cue_1 = gsub("-i.*", "", gsub("_.*", "", id_1)),
    cue_2 = gsub("-i.*", "", gsub("_.*", "", id_2)),
    log_1 = ifelse(str_detect(id_1, "log"), "log10", ""),
    log_2 = ifelse(str_detect(id_2, "log"), "log10", ""),
    id_1_alt = paste(cue_1, log_1),
    id_2_alt = paste(cue_2, log_2))

# write and import back
write.csv(ci_comp_static.df, here("data/ci_comp_static.csv"), row.names = F)

```


#-----------------------#
# code for invasion analysis of ci
#-----------------------#
Note that we have 2 options: start optimization with mutant parameter (from optimized with same strain same strategy), or start optimization with rep(0.5, 4). For safe proof, we could use DE (which is very slow), or we can perform this twice with both rep(0.5,4) and optimized mutant parameters -> compare results. 
```{r}
ci_invasion_analysis <- function(df, default = T){
  
  # get mutant info (invader)
  if(default == F){mut_par <- c(df$var1, df$var2, df$var3, df$var4)} ## mutant parameter. if default is false, start optimization with optimized parameter set for mutant
  if(default == T){mut_par <- rep(0.5, 4)} ## if default is true, start optimization with 0.5x4
  if(stringr::str_detect(df$cue, "-i")){mut_cue = paste0(gsub("*-i", "", df$cue), "1")} ## mutant cue
  if(stringr::str_detect(df$cue, "-i", negate = T)){mut_cue = df$cue} ## mutant cue
  if(stringr::str_detect(df$log, "log")){mut_log = "log10"} ## mutant log
  if(stringr::str_detect(df$log, "none")){mut_log = "none"} ## mutant log
  mut_cue_range <- seq(df$low, df$high, by = df$by) ## mutant cue range
  
  # get resident info (being invaded)
  res_par <- c(df$var1_2, df$var2_2, df$var3_2, df$var4_2) ## resident parameter
  if(stringr::str_detect(df$cue_2, "-i")){res_cue = paste0(gsub("*-i", "", df$cue_2), "2")} ## resident cue
  if(stringr::str_detect(df$cue_2, "-i", negate = T)){res_cue = df$cue_2} ## resident cue
  if(stringr::str_detect(df$log_2, "log")){res_log = "log10"} ## resident log
  if(stringr::str_detect(df$log_2, "none")){res_log = "none"} ## resident log
  res_cue_range <- seq(df$low_2, df$high_2, by = df$by_2) ## resident cue range

  # get ids
  mut_id <- df$id
  res_id <- df$id_2
  
  # one way optimization
  ## start cluster
  cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
  
  # start optimization LFBGS
  res <- optimParallel(
    par = mut_par,
    fn = chabaudi_ci_clean, 
    control = list(trace = 6, fnscale = -1),
    parameters_cr_2 = res_par,
    immunity = "tsukushi",
    parameters = parameters_tsukushi,
    time_range = seq(0, 20, by = 1e-3),
    cue_range_1 = mut_cue_range,
    cue_range_2 = res_cue_range,
    cue_1 = mut_cue,
    cue_2 = res_cue,
    log_cue_1 = mut_log,
    log_cue_2 = res_log,
    solver = "vode")
  
  # close cluster
  stopCluster(cl)
  
  # get model output
  fitness <- res$value ## fitness difference between mutant and residence
  mut_opt_par <- res$par ## optimized parameters of mutant
  
  # produce output
  output <- cbind.data.frame(mut_id = mut_id, res_id = res_id, 
                             fitness = fitness, 
                             mut_var1 = df$var1, mut_var2 = df$var2, mut_var3 = df$var3, mut_var4 = df$var4,
                             res_var1 = df$var1_2, res_var2 = df$var2_2, res_var3 = df$var3_2, res_var4 = df$var4_2,
                             mut_var1_opt = mut_opt_par[1], mut_var2_opt = mut_opt_par[2], mut_var3_opt = mut_opt_par[3], mut_var4_opt = mut_opt_par[4])
  
  write.csv(output, here(paste0("data/ci_invasion/", mut_id, "_", res_id, ".csv")))
  return(output)

  
}
```

# note for all runs, used 0.5 as starting point unless competing against residence G1+G2 log where I set starting to point to optimal if optimization failed (completed within <1 cycle)
```{r}
# get all unique pairwise competition. zThis is already calculated above. For 13 cues, 13^2 = 169
# get rid of all same
ci_cue_pair.df3 <- ci_cue_pair.df %>% filter(id!=id_2)
write.csv(ci_cue_pair.df3, here("job_scripts/ci_cue_par.csv"), row.names = F)

ci_cue_pair.ls3 <- split(ci_cue_pair.df3, seq(nrow(ci_cue_pair.df3)))

```

# process data
```{r}
# import list of all dataframes (210 of them!)
invasion.ls <- list.files(path = here("data/ci_invasion/"), pattern = "*.csv", full.names = T)

# read and bind
invasion_df.ls <- lapply(invasion.ls, read.csv)
invasion.df <- do.call(rbind, invasion_df.ls)

# get label
invasion.df2 <- invasion.df %>% 
  mutate(
    mut_cue = gsub("-i.*", "", gsub("_.*", "", mut_id)),
    res_cue = gsub("-i.*", "", gsub("_.*", "", res_id)),
    mut_log = ifelse(str_detect(mut_id, "log"), "log10", ""),
    res_log = ifelse(str_detect(res_id, "log"), "log10", ""),
    mut_alt = paste(mut_cue, mut_log),
    res_alt = paste(res_cue, res_log))

write.csv(invasion.df2, here("data/ci_invasion_final.csv"))
```


#=============================#
# how does co-infection fare in single infection situation
#=============================#

Note translating co-infection cue to single infection cue

1) individual based cues (e.g. I-i) is directly translated to I-i
2) sum cues (I1+I2) is just I
3) sum = I+Ig

40 days simulation to ensure full resolution
```{r}
# function to get dynamics of optimal conversion 
compare_ci_si_dyn <- function(df){
  
  # get info of cues (for co infection)
  if(stringr::str_detect(df$cue, "-i")){cue_1 = paste0(gsub("*-i", "", df$cue), "1")}
  if(stringr::str_detect(df$cue, "-i", negate = T)){cue_1 = df$cue}
  if(stringr::str_detect(df$cue, "-i")){cue_2 = paste0(gsub("*-i", "", df$cue), "2")}
  if(stringr::str_detect(df$cue, "-i", negate = T)){cue_2 = df$cue}
  
  # get log
  if(stringr::str_detect(df$log, "log")){log = "log10"}
  if(stringr::str_detect(df$log, "none")){log = "none"}
  
  # get info of cues for single infection model
  cue_s <- df$cue
  if(stringr::str_detect(df$cue, "-i")){cue_s = gsub("*-i", "", df$cue)} # convert any cues with X-i ending to just X
  if(stringr::str_detect(df$cue, "1+")){cue_s = gsub("*1+.*", "", df$cue)} # convert any of the X1+X2 to just X
  if(df$cue == "sum"){cue_s = "I+Ig"}# manual assignment
  
  # get parameters
  par <- c(df$var1, df$var2, df$var3, df$var4)
  # get cue range
  cue_range <- seq(df$low, df$high, by = df$by)
  # get label
  label <- df$label_3
  
  # get dynamics of co infection
  ci_dyn <- chabaudi_ci_clean(
    parameters_cr_1 = par,
    parameters_cr_2 = par,
                  immunity = "tsukushi",
                  parameters = parameters_tsukushi,
                  cue_1 = cue_1,
                  cue_2 = cue_2,
                  cue_range_1 = cue_range,
                 cue_range_2 = cue_range,
                log_cue_1 = log,
                log_cue_2 = log,
                  solver = "vode",
                  time_range = seq(0, 40, 0.001),
    dyn = T)
  
  # get dynamics of single infection
  si_dyn <- chabaudi_si_clean(
        parameters_cr = par, 
        parameters = parameters_tsukushi, 
        immunity = "tsukushi",
       time_range = seq(0, 40, 0.001), 
        cue = cue_s, 
        cue_range = cue_range, 
        log_cue = log,
        solver = "vode",
        dyn = TRUE)
  
  # append label to all df
 ci_dyn2 <- cbind(ci_dyn, label = rep(label, nrow(ci_dyn)))
  si_dyn2 <- cbind(si_dyn, label = rep(label, nrow(si_dyn)))
  
  # return df
 return(list(ci_dyn2, si_dyn2))

  
}

```

# processing input df (full set)
```{r}
source(here("functions/chabaudi_ci_clean.R"))
# importing in updated co-infection df with full set (15 cues)
ci_opt.df <- read.csv(here("data/ci_opt.csv"))

# reclass for better labels
ci_opt.df <- ci_opt.df %>% 
  mutate(label_1 = case_when(
  cue == "I-i" ~ "Asexual iRBC",
  cue == "I1+I2" ~ "Total asexual\niRBC",
  cue == "Ig-i" ~ "Sexual iRBC",
  cue == "Ig1+Ig2" ~ "Total sexual\niRBC",
  cue == "sum" ~ "Total iRBC",
  cue == "G-i" ~ "Gametocyte",
  cue == "G1+G2" ~ "Total\ngametocyte",
  cue == "R" ~ "RBC"
)) %>% 
  mutate(label_2 = case_when(
    log == "log" ~ "log10",
    log == "none" ~ ""
  )) %>% 
  mutate(label_3 = paste(label_1, label_2),
         id = paste0(cue, "_", log))

# left join with cue range df
cue_range.df <- read.csv(here("data/cue_range.csv"))

ci_opt.df <- ci_opt.df %>% left_join(select(cue_range.df, low, high, by, id), by = c("id" = "id"))
```

# get si vs ci comparison
```{r}
ci_opt.ls <- split(ci_opt.df, seq(nrow(ci_opt.df)))
ci_si_comp <- mclapply(ci_opt.ls, compare_ci_si_dyn, mc.cores = 8)

# bind all ci dynamics
ci_si_comp.ci <- lapply(ci_si_comp, function(x){rbind(x[[1]])})
ci_si_comp.ci2 <- do.call(rbind, ci_si_comp.ci)

# bind all si dynamics
ci_si_comp.si <- lapply(ci_si_comp, function(x){rbind(x[[2]])})
ci_si_comp.si2 <- do.call(rbind, ci_si_comp.si)


# write parquet
#arrow::write_parquet(ci_si_comp.ci2, here("data/ci_in_si/ci_si_comp_ci.parquet"))
#arrow::write_parquet(ci_si_comp.si2, here("data/ci_in_si/ci_si_comp_si.parquet"))

#read
ci_si_comp.ci <- arrow::read_parquet(here("data/ci_dyn/ci_opt_40.parquet"))
ci_si_comp.si <- arrow::read_parquet(here("data/si_dyn/si_non_opt_40.parquet"))

```

# process dataframe. Get time to resolution
# we get the first point where the average iRBC dips below 9000 (number determined by trials and errors in 40 days simulation)
```{r}
# need to get period of infection resolution
# we can define this as when total iRBC fill below certain criteria
iRBC_bound <- 9000
time_ci_si.si <- ci_si_comp.si %>% 
  filter(variable == "I" | variable == "Ig") %>% 
  filter(time > 10) %>% 
  group_by(label, time) %>% 
  mutate(avg = sum(value)/2) %>% 
  filter(avg < iRBC_bound) %>% 
  group_by(label) %>% 
  arrange(time) %>% 
  dplyr::slice_head(n = 1)

time_ci_si.ci <- ci_si_comp.ci %>% 
  filter(variable == "I1" | variable == "Ig1") %>% 
  filter(time > 10) %>% 
  group_by(label, time) %>% 
  mutate(avg = sum(value)/2) %>% 
  filter(avg < iRBC_bound) %>% 
  group_by(label) %>% 
  arrange(time) %>% 
  dplyr::slice_head(n = 1)
```


#--------------------------------_#
# comparing single infectio vs coinfection
#---------------------------------#
# compare fitness rank order for cues in single infection scenario vs co-infection scenario
Will run this for 30 days. Note that here the parameter values are different and I am just taking the optimum for each one
```{r}
source(here("functions/chabaudi_si_clean.R"))
# function fro getting dynamics
get_si_dyn <- function(df){
  par <- c(df$var1, df$var2, df$var3, df$var4)
  cue <- df$cue
  log <- ifelse(df$log=="log", "log10", "none")
  cue_range <- seq(df$low, df$high, by = df$by)
  id <- df$id
  
  # get dynamics. simulate 30 days to get resolution
  dyn <- chabaudi_si_clean(
            parameters_cr = par, 
            parameters = parameters_tsukushi, 
            time_range = seq(0, 30, 0.001), 
            cue = cue, 
            cue_range = cue_range, 
            log_cue = log,
            immunity = "tsukushi",
            solver = "vode",
            dyn = TRUE)
  
  # append id
  dyn2 <- cbind(dyn, id = rep(id, nrow(dyn)))
  
 return(dyn2)
}

# import in si_opt
si_opt.df <- read.csv(here("data/si_opt.csv"))
# left join with cue range
cue_range.si <- read.csv(here("data/cue_range_si.csv"))

si_opt.df <- si_opt.df %>% left_join(cue_range.si)

# loop through to get dynamics
## split into list
si_opt.ls <- split(si_opt.df, seq(nrow(si_opt.df)))
si_dyn <- mclapply(si_opt.ls, get_si_dyn, mc.cores = 6)
si_dyn.df <- do.call( rbind, si_dyn)

#write_parquet(si_dyn.df, here("data/si_dyn/si_dyn_30.parquet"))
si_dyn.df <- read_parquet(here("data/si_dyn/si_dyn_30.parquet"))
```

#---------------Which cues are good for both single infection and co-infection (if optimized separately?)-------#
# process data -> get max fitness for single infection and pair that with co-infection data
```{r}
# get max fitness
si_fitness <- si_dyn.df %>% 
  filter(variable == "tau_cum") %>% 
  group_by(id) %>% 
  summarize(fitness = max(value))

# get max fitness for ci
ci_si_comp.ci <- arrow::read_parquet(here("data/ci_dyn/ci_opt_40.parquet"))
ci_fitness <- ci_si_comp.ci %>% 
  filter(variable == "tau_cum1") %>% 
  mutate(value = ifelse(is.finite(value), value, 0)) %>% 
  group_by(label) %>% 
  summarise(fitness = max(value)*2)

# recode si_fitness to get label
si_fitness2 <- si_fitness %>% 
  mutate(cue = gsub("_.*", "", id),
         log = gsub(".*_", "",  id)) %>% 
  mutate(label_si = ifelse(log == "log", paste(cue, log), cue)) %>% 
  select(label_si, cue, fitness_si = fitness)

# recode ci_fitness to get label
ci_fitness2 <- ci_fitness %>% 
  left_join(ci_opt.df, by = c("label"="label_3")) %>% 
  mutate(label_ci = ifelse(log == "log", paste(cue, log), cue)) %>% 
  mutate(cue_si = case_when(
    stringr::str_detect(cue, "-i") ~ gsub("*-i", "", cue),
    stringr::str_detect(cue, "1+") ~ gsub("*1+.*", "", cue),
    stringr::str_detect(cue, "sum") ~ "I+Ig",
    TRUE ~ cue
  ),
  label_si = ifelse(log == "log", paste(cue_si, log), cue_si)) %>% 
  select(label_si, label_ci, cue, fitness_ci = fitness)

si_ci_fitness2 <- left_join(ci_fitness2, si_fitness2, by = "label_si")
#write.csv(si_ci_fitness2, here("data/si_ci_diff/si_ci_max_fitness.csv"))

# plot fitness!
library(scales)
```

#-------------------------How does dynamics of optimal co-infection, optimal single-infection, non-optimal single infection, and non-optimal co-infection compare---------------------------------------------------#

# we have previously simulated the dynamics of optimal ci, si, and non optimal si (where ci strategy is adopted). Need to simulate non-optimal ci (where si strategy is adopted)

```{r}
# import in non-optimal co-infection parameters
ci_non_opt.df <- read.csv(here("data/ci_non_opt.csv"))

# join with cue range 
# reclass for better labels
ci_non_opt.df <- ci_non_opt.df %>% 
  mutate(label_1 = case_when(
  cue == "I-i" ~ "Asexual iRBC",
  cue == "I1+I2" ~ "Total asexual\niRBC",
  cue == "Ig-i" ~ "Sexual iRBC",
  cue == "Ig1+Ig2" ~ "Total sexual\niRBC",
  cue == "sum" ~ "Total iRBC",
  cue == "G-i" ~ "Gametocyte",
  cue == "G1+G2" ~ "Total\ngametocyte",
  cue == "R" ~ "RBC"
)) %>% 
  mutate(label_2 = case_when(
    log == "log" ~ "log10",
    log == "none" ~ ""
  )) %>% 
  mutate(label_3 = paste(label_1, label_2),
         id = paste0(cue, "_", log))

# left join with cue range df
cue_range.df <- read.csv(here("data/cue_range.csv"))

ci_non_opt.df<- ci_non_opt.df %>% left_join(select(cue_range.df, low, high, by, id), by = c("id" = "id"))
```

# function to get ci dynamics
```{r}
get_ci_dyn <- function(df){
  
  # get info of cues (for co infection)
  if(stringr::str_detect(df$cue, "-i")){cue_1 = paste0(gsub("*-i", "", df$cue), "1")}
  if(stringr::str_detect(df$cue, "-i", negate = T)){cue_1 = df$cue}
  if(stringr::str_detect(df$cue, "-i")){cue_2 = paste0(gsub("*-i", "", df$cue), "2")}
  if(stringr::str_detect(df$cue, "-i", negate = T)){cue_2 = df$cue}
  
  # get log
  if(stringr::str_detect(df$log, "log")){log = "log10"}
  if(stringr::str_detect(df$log, "none")){log = "none"}
  
  # get parameters
  par <- c(df$var1, df$var2, df$var3, df$var4)
  # get cue range
  cue_range <- seq(df$low, df$high, by = df$by)
  # get label
  label <- df$label_3
  
  # get dynamics of co infection
  ci_dyn <- chabaudi_ci_clean(
    parameters_cr_1 = par,
    parameters_cr_2 = par,
                  immunity = "tsukushi",
                  parameters = parameters_tsukushi,
                  cue_1 = cue_1,
                  cue_2 = cue_2,
                  cue_range_1 = cue_range,
                 cue_range_2 = cue_range,
                log_cue_1 = log,
                log_cue_2 = log,
                  solver = "vode",
                  time_range = seq(0, 40, 0.001),
    dyn = T)
  
  # append label to all df
 ci_dyn2 <- cbind(ci_dyn, label = rep(label, nrow(ci_dyn)))

  # return df
 return(ci_dyn2)
}
```

# get non-optimal ci dynamics
```{r}
source(here("functions/chabaudi_ci_clean.R"))
ci_non_opt.ls <- split(ci_non_opt.df, seq(nrow(ci_non_opt.df)))
ci_non_opt.dyn <- mclapply(ci_non_opt.ls, get_ci_dyn, mc.cores = 6)
ci_non_opt.res <- do.call(rbind, ci_non_opt.dyn)

#write_parquet(ci_non_opt.res, here("data/ci_dyn/ci_non_opt_40.parquet"))
```



#------------------------- get conversion rate difference---------------#
We need to filter each dataset based on resolution time (calculated above) and compare average conversion rate across the period
```{r}
# resolution time for optimal co-infectin
resolution_time.ci <- time_ci_si.ci %>% 
  select(resolution_time_ci = time, label)

# resolution time for non-optimal single infection
resolution_time.si_n <- time_ci_si.si %>% 
  select(resolution_time_si = time, label)

# calculate resolution for optial single ifneciton
resolution_time.si <- si_dyn.df %>% 
  filter(variable == "I" | variable == "Ig") %>% 
  filter(time > 10) %>% 
  group_by(id, time) %>% 
  mutate(avg = sum(value)/2) %>% 
  filter(avg < iRBC_bound) %>% 
  group_by(id) %>% 
  arrange(time) %>% 
  dplyr::slice_head(n = 1) %>% 
  select(resolution_time_si = time, id)

# calculate resolution time for non-optimal co-infection
resolution_time.ci_n <- ci_non_opt.res %>% 
  filter(variable == "I1" | variable == "Ig1") %>% 
  filter(time > 10) %>% 
  group_by(label, time) %>% 
  mutate(avg = sum(value)/2) %>% 
  filter(avg < iRBC_bound) %>% 
  group_by(label) %>% 
  arrange(time) %>% 
  dplyr::slice_head(n = 1) %>% 
  select(resolution_time_ci_n = time, label)

resolution_time.ci_n

# save resolution time
#write.csv(resolution_time.ci, here("data/si_ci_diff/opt_ci_resolution.csv"))
#write.csv(resolution_time.si, here("data/si_ci_diff/opt_si_resolution.csv"))
#write.csv(resolution_time.si_n, here("data/si_ci_diff/opt_si_n_resolution.csv"))
#write.csv(resolution_time.ci_n, here("data/si_ci_diff/opt_ci_n_resolution.csv"))
```

# process conversion rate
```{r}
# get average conversion rate for optimal single infection
avg_cr.si <- si_dyn.df %>% 
  left_join(resolution_time.si) %>% 
  filter(variable == "cr") %>% 
  group_by(id) %>% 
  filter(time <= resolution_time_si,
         !is.na(value)) %>% 
  summarise(mean_cr = mean(value))
  
#write.csv(avg_cr.si, here("data/si_ci_diff/opt_si_cr.csv"))

# get average conversion rate for optimal co-infection
avg_cr.ci <- ci_si_comp.ci %>% 
  left_join(resolution_time.ci) %>% 
  filter(variable == "cr_1") %>% 
  group_by(label) %>% 
  filter(time <= resolution_time_ci,
         !is.na(value)) %>% 
  summarise(mean_cr = mean(value))
#write.csv(avg_cr.ci, here("data/si_ci_diff/opt_ci_cr.csv"))

# get average conversion rate for non-optimal single infection (co-infeciton)
avg_cr.si_non <- ci_si_comp.si %>% 
  left_join(resolution_time.si_n) %>% 
  filter(variable == "cr") %>% 
  group_by(label) %>% 
  filter(time <= resolution_time_si,
         !is.na(value)) %>% 
  summarise(mean_cr_si_n = mean(value))

write.csv(avg_cr.si_non, here("data/si_ci_diff/non_opt_si_cr.csv"))

# get average conversion rate for non-optimal co-infection
avg_cr.ci_non <- ci_non_opt.res %>% 
  left_join(resolution_time.ci_n) %>% 
  filter(variable == "cr_1") %>% 
  group_by(label) %>% 
  filter(time <= resolution_time_ci_n,
         !is.na(value)) %>% 
  summarise(mean_cr_ci_n = mean(value))

write.csv(avg_cr.ci_non, here("data/si_ci_diff/non_opt_ci_cr.csv"))
```

# process data for plotting. mainly adjusting the labels and transforming to long form
```{r}
avg_cr.si2 <- avg_cr.si %>% 
  mutate(cue = gsub("_.*", "", id),
         log = gsub(".*_", "",  id)) %>% 
  mutate(label_si = ifelse(log == "log", paste(cue, log), cue)) %>% 
  select(label_si, mean_cr_si = mean_cr)

avg_cr.ci2 <- avg_cr.ci %>% 
  left_join(ci_opt.df, by = c("label"="label_3")) %>% 
  mutate(label_ci = ifelse(log == "log", paste(cue, log), cue)) %>% 
  mutate(cue_si = case_when(
    stringr::str_detect(cue, "-i") ~ gsub("*-i", "", cue),
    stringr::str_detect(cue, "1+") ~ gsub("*1+.*", "", cue),
    stringr::str_detect(cue, "sum") ~ "I+Ig",
    TRUE ~ cue
  ),
  label_si = ifelse(log == "log", paste(cue_si, log), cue_si)) %>% 
  select(label_si, mean_cr_ci = mean_cr, label)

avg_cr.si_non2 <- avg_cr.si_non %>% 
  left_join(select(avg_cr.ci2, label_si, label)) %>% 
  select(label_si, mean_cr_si_n, label)

avg_cr.ci_non2 <- avg_cr.ci_non %>% 
  left_join(ci_opt.df, by = c("label"="label_3")) %>% 
  mutate(label_ci = ifelse(log == "log", paste(cue, log), cue)) %>% 
  mutate(cue_si = case_when(
    stringr::str_detect(cue, "-i") ~ gsub("*-i", "", cue),
    stringr::str_detect(cue, "1+") ~ gsub("*1+.*", "", cue),
    stringr::str_detect(cue, "sum") ~ "I+Ig",
    TRUE ~ cue
  ),
  label_si = ifelse(log == "log", paste(cue_si, log), cue_si)) %>% 
  select(label_si, mean_cr_ci_n, label)

# join
avg_cr.all <- left_join(avg_cr.ci2, avg_cr.si2, by = "label_si") %>% 
  left_join(avg_cr.si_non2, by = "label") %>% 
  left_join(avg_cr.ci_non2, by = "label") %>% 
  select(label = label, mean_cr_ci, mean_cr_si, mean_cr_si_n, mean_cr_ci_n)


avg_cr.all2 <- tidyr::pivot_longer(avg_cr.all, -label) %>% 
  mutate(infection = case_when(
    name == "mean_cr_ci" ~ "Optimal co-infection",
    name == "mean_cr_si" ~ "Optimal single infection",
    name == "mean_cr_si_n" ~ "Non-optimal single infection",
    name == "mean_cr_ci_n" ~ "Non-optimal co-infection"
  )) %>% 
  group_by(label) %>% 
  mutate(avg = mean(value))


```

# how about resolution time?
```{r}
# need to process optimal ci so it has labels
resolution_time.ci2 <- resolution_time.ci %>% 
  left_join(ci_opt.df, by = c("label"="label_3")) %>% 
  mutate(label_ci = ifelse(log == "log", paste(cue, log), cue)) %>% 
  mutate(cue_si = case_when(
    stringr::str_detect(cue, "-i") ~ gsub("*-i", "", cue),
    stringr::str_detect(cue, "1+") ~ gsub("*1+.*", "", cue),
    stringr::str_detect(cue, "sum") ~ "I+Ig",
    TRUE ~ cue
  ),
  label_si = ifelse(log == "log", paste(cue_si, log), cue_si)) %>% 
  select(label_si, resolution_time_ci, label)

# process si to get label_si
resolution_time.si2 <- resolution_time.si %>% 
  mutate(cue = gsub("_.*", "", id),
         log = gsub(".*_", "",  id)) %>% 
  mutate(label_si = ifelse(log == "log", paste(cue, log), cue)) %>% 
  select(label_si, resolution_time_si_opt = resolution_time_si)

# left_join resolution time for nonoptimal single infection
resolution_time.all <- left_join(resolution_time.ci2, resolution_time.si_n, by = "label") %>% 
  left_join(resolution_time.ci_n, by = "label") %>% 
  left_join(resolution_time.si2, by = "label_si")

# make long and recode
resolution_time.all2 <- tidyr::pivot_longer(select(resolution_time.all, -id, -label_si), -label) %>% 
  mutate(infection = case_when(
    name == "resolution_time_ci" ~ "Optimal co-infection",
    name == "resolution_time_si" ~"Non-optimal single infection",
    name == "resolution_time_si_opt" ~"Optimal single infection",
    name == "resolution_time_ci_n" ~"Non-optimal co-infection"
  )) %>% 
  group_by(label) %>% 
  mutate(avg = mean(value))



```

# fitness difference
# ge data
```{r}
# get maximum fitness for optimal single infection
fitness.si <- si_dyn.df %>% 
  filter(variable == "tau_cum") %>% 
  group_by(id) %>%
  mutate(value = ifelse(is.na(value), 0, value)) %>% 
  summarise(fitness_si = max(value))
  
write.csv(fitness.si, here("data/si_ci_diff/si_opt_fitness.csv"))

# get maximum fitness for optimal co-ineciton, note that we are multiplykng by 2 to get total infection of both strains (since they are adopting the same strategy)
fitness.ci <- ci_si_comp.ci %>% 
  filter(variable == "tau_cum1") %>% 
  group_by(label) %>% 
  mutate(value = ifelse(is.na(value), 0, value)) %>% 
  summarise(fitness_ci = max(value)*2)

write.csv(fitness.ci, here("data/si_ci_diff/ci_opt_fitness.csv"))

# get average conversion rate for non-optimal single infection (co-infeciton)
fitness_non.si <- ci_si_comp.si %>% 
  filter(variable == "tau_cum") %>% 
  group_by(label) %>%
  mutate(value = ifelse(is.na(value), 0, value)) %>% 
  summarise(fitness_non_si = max(value))

write.csv(fitness_non.si, here("data/si_ci_diff/si_non_opt_fitness.csv"))

# get average conversion rate for non-optimal co-infection
fitness_non.ci <- ci_non_opt.res %>% 
  filter(variable == "tau_cum1") %>% 
  group_by(label) %>% 
  mutate(value = ifelse(is.na(value), 0, value)) %>% 
  summarise(fitness_non_ci = max(value)*2)
  
write.csv(fitness_non.ci, here("data/si_ci_diff/ci_non_opt_fitness.csv"))

# join all
## need to first get si_id
fitness.ci2 <- fitness.ci %>% 
  left_join(ci_opt.df, by = c("label"="label_3")) %>% 
  mutate(label_ci = ifelse(log == "log", paste(cue, log), cue)) %>% 
  mutate(cue_si = case_when(
    stringr::str_detect(cue, "-i") ~ gsub("*-i", "", cue),
    stringr::str_detect(cue, "1+") ~ gsub("*1+.*", "", cue),
    stringr::str_detect(cue, "sum") ~ "I+Ig",
    TRUE ~ cue
  ),
  label_si = ifelse(log == "log", paste(cue_si, log), cue_si)) %>% 
  select(label_si, fitness_ci, label)

fitness.si2 <- fitness.si %>% 
  mutate(cue = gsub("_.*", "", id),
         log = gsub(".*_", "",  id)) %>% 
  mutate(label_si = ifelse(log == "log", paste(cue, log), cue)) %>% 
  select(label_si, fitness_si)

fitness.all <- left_join(fitness.ci2, fitness.si2, by = "label_si") %>% 
  left_join(fitness_non.si,  by = "label") %>% 
  left_join(fitness_non.ci, by = "label") %>% 
  select(label, fitness_ci, fitness_si, fitness_non_si, fitness_non_ci)

fitness.all2 <- tidyr::pivot_longer(fitness.all, -label) %>% 
  mutate(infection = case_when(
    name == "fitness_ci" ~ "Optimal co-infection",
    name == "fitness_non_si" ~"Non-optimal single infection",
    name == "fitness_si" ~"Optimal single infection",
    name == "fitness_non_ci" ~"Non-optimal co-infection"
  )) %>% 
  group_by(label) %>% 
  mutate(avg = mean(value))
```

# get host RBC decline (lowest point) and max iRBC (total count)
```{r}
# get maximum fitness for optimal single infection
RBC.si <- si_dyn.df %>% 
  filter(variable == "R") %>% 
  group_by(id) %>%
  summarise(RBC_si = min(value))

# get maximum fitness for optimal co-ineciton, note that we are multiplykng by 2 to get total infection of both strains (since they are adopting the same strategy)
RBC.ci <- ci_si_comp.ci %>% 
  filter(variable == "R") %>% 
  group_by(label) %>% 
  summarise(RBC_ci = min(value))

# get average conversion rate for non-optimal single infection (co-infeciton)
RBC_non.si <- ci_si_comp.si %>% 
  filter(variable == "R") %>% 
  group_by(label) %>%
  summarise(RBC_non_si = min(value))

# get average conversion rate for non-optimal co-infection
RBC_non.ci <- ci_non_opt.res %>% 
  filter(variable == "R") %>% 
  group_by(label) %>% 
  summarise(RBC_non_ci = min(value))

# join all
## need to first get si_id
RBC.ci2 <- RBC.ci %>% 
  left_join(ci_opt.df, by = c("label"="label_3")) %>% 
  mutate(label_ci = ifelse(log == "log", paste(cue, log), cue)) %>% 
  mutate(cue_si = case_when(
    stringr::str_detect(cue, "-i") ~ gsub("*-i", "", cue),
    stringr::str_detect(cue, "1+") ~ gsub("*1+.*", "", cue),
    stringr::str_detect(cue, "sum") ~ "I+Ig",
    TRUE ~ cue
  ),
  label_si = ifelse(log == "log", paste(cue_si, log), cue_si)) %>% 
  select(label_si, RBC_ci, label)

RBC.si2 <- RBC.si %>% 
  mutate(cue = gsub("_.*", "", id),
         log = gsub(".*_", "",  id)) %>% 
  mutate(label_si = ifelse(log == "log", paste(cue, log), cue)) %>% 
  select(label_si, RBC_si)

RBC.all <- left_join(RBC.ci2, RBC.si2, by = "label_si") %>% 
  left_join(RBC_non.si,  by = "label") %>% 
  left_join(RBC_non.ci, by = "label") %>% 
  select(label, RBC_ci, RBC_si, RBC_non_si, RBC_non_ci)

RBC.all2 <- tidyr::pivot_longer(RBC.all, -label) %>% 
  mutate(infection = case_when(
    name == "RBC_ci" ~ "Optimal co-infection",
    name == "RBC_non_si" ~"Non-optimal single infection",
    name == "RBC_si" ~"Optimal single infection",
    name == "RBC_non_ci" ~"Non-optimal co-infection"
  )) %>% 
  group_by(label) %>% 
  mutate(avg = mean(value))

write.csv(RBC.all2, here("data/si_ci_diff/RBC_diff_final.csv"))
```




#-------------------------------------------------------#
# Final plotting. Figure on si vs ci difference
#-------------------------------------------------------#
# reaction norm of ci
```{r}
ci_rn_lim.df <- read.csv(here("data/ci_dyn/ci_rn_lim.csv"))
ci_rug.df <- read.csv(here("data/ci_dyn/ci_rug.csv"))

ci_rn.pl <- ggplot() +
  geom_line(data = ci_rn_lim.df, aes(x = cue_range, y = cr)) +
  geom_rug(data = ci_rug.df, aes(x = value), color = "red") +
  facet_wrap(~label, scales = "free_x", ncol = 2) +
  theme_bw() +
  labs(y = "Conversion rate", x = "Cue range") +
  scale_x_continuous(labels = function(x) format(x, scientific = FALSE),
                     guide = guide_axis(check.overlap = TRUE)) + 
                    theme(axis.text.x = element_text(size = 7))  +
  theme(plot.margin=margin(r=30))
```


# what is the best cue when optimized separately for si and ci?
```{r}
si_ci_fitness2 <- read.csv(here("data/si_ci_diff/si_ci_max_fitness.csv"))

# first part
fitness_ci_si.pl1 <- ggplot() +
  geom_point(data = si_ci_fitness2, aes(x = fitness_ci, y = fitness_si, color = label_si, shape = label_si), size = 2.5) +
  ggrepel::geom_label_repel(data = si_ci_fitness2, aes(label = label_ci, x = fitness_ci, y = fitness_si),
                            fill = "white",xlim = c(-Inf, Inf), ylim = c(NA, NA)) +
  scale_x_continuous(n.breaks = 2,
                     limits = c(0, 0.1)) +
  labs(x = "", y = "Optimal single infection fitness",
       color = "Single infection cue", shape = "Single infection cue") +
  scale_shape_manual(values = 15:24) +
  theme_bw() +
  coord_cartesian(clip = "off") +
  theme(plot.margin=margin(r=0))

# second part
fitness_ci_si.pl2 <-ggplot() +
  geom_point(data = si_ci_fitness2, aes(x = fitness_ci, y = fitness_si, color = label_si, shape = label_si), size = 2.5) +
  coord_cartesian(clip = "off") +
  ggrepel::geom_label_repel(data = si_ci_fitness2, aes(label = label_ci, x = fitness_ci, y = fitness_si),
                            fill = "white") +
  scale_x_continuous(
    breaks = scales::pretty_breaks(n = 5),
    labels = scales::number_format(accuracy = 0.01,
                                 decimal.mark = '.'),
    expand = expansion(mult = 0.5)) +
  xlim(3,5) +
  labs(x = "Optimal co-infection fitness", y = "",
       color = "Single infection cue", shape = "Single infection cue") +
  scale_shape_manual(values = 15:24) +
  theme_bw() +
  theme(plot.margin=margin(l=0))

fitness_ci_si.pl <- ggarrange(fitness_ci_si.pl1, fitness_ci_si.pl2, widths = c(0.2, 1), align = "hv", common.legend = T)
```

# comparison of optimized vs unoptimized si and ci dynamic
```{r}
# write all data frames for subsequent pltting
#write.csv(resolution_time.all2, here("data/si_ci_diff/time_diff_final.csv"))
#write.csv(avg_cr.all2, here("data/si_ci_diff/cr_diff_final.csv"))
#write.csv(fitness.all2, here("data/si_ci_diff/fitness_diff_final.csv"))

# read in data
resolution_time.all2 <- read.csv(here("data/si_ci_diff/time_diff_final.csv"))
avg_cr.all2 <- read.csv(here("data/si_ci_diff/cr_diff_final.csv"))
fitness.all2 <- read.csv(here("data/si_ci_diff/fitness_diff_final.csv"))
RBC.all2 <- read.csv(here("data/si_ci_diff/RBC_diff_final.csv"))


# plot
time_diff.pl <- ggplot(resolution_time.all2, aes(x = value, y = reorder(label, avg))) + # rank by co-infection resolution time
  geom_line(aes(group = label)) +
  geom_point(aes(color = infection, shape = infection), size = 2.5, alpha = 0.7) +
  labs(x = "Resolution time (days)", y = "Cue", color = "Infection", shape = "Infection") +
  scale_shape_manual(values = 15:18) +
  theme_bw()+
  theme(axis.text = element_text(size = 6))

fitness_diff.pl <- ggplot(fitness.all2, aes(x = value, y = reorder(label, avg))) + # rank by co-infection resolution time
  geom_line(aes(group = label)) +
  geom_point(aes(color = infection, shape = infection), size = 2.5, alpha = 0.7) +
  labs(x = "Fitness", y = "Cue", color = "Infection", shape = "Infection") +
  scale_shape_manual(values = 15:18) +
  theme_bw()+
  theme(axis.text = element_text(size = 6))

cr_diff.pl <- ggplot(avg_cr.all2, aes(x = value, y = reorder(label, avg))) + # rank by co-infection resolution time
  geom_line(aes(group = label)) +
  geom_point(aes(color = infection, shape = infection), size = 2.5, alpha= 0.7) +
  labs(x = "Average conversion rate", y = "Cue", color = "Infection", shape = "Infection") +
  scale_shape_manual(values = 15:18) +
  theme_bw()+
  theme(axis.text = element_text(size = 6))

RBC_diff.pl <- ggplot(RBC.all2, aes(x = value, y = reorder(label, avg))) + # rank by co-infection resolution time
  geom_line(aes(group = label)) +
  geom_point(aes(color = infection, shape = infection), size = 2.5, alpha= 0.7) +
  labs(x = "Minimum RBC (cells/\U003BCL)", y = "Cue", color = "Infection", shape = "Infection") +
  scale_shape_manual(values = 15:18) +
  theme_bw() +
  theme(axis.text = element_text(size = 6))

# ggarrange
opt_nonopt.pl <- ggarrange(fitness_diff.pl, cr_diff.pl, time_diff.pl, RBC_diff.pl,common.legend = T, align = "v")

opt_nonopt.pl
```

# putting everything together
```{r}
fitness_non_opt <- ggarrange(fitness_ci_si.pl, opt_nonopt.pl, ncol = 1, labels = c("B", "C"), heights = c(1, 1.5))

ggarrange(ci_rn.pl, fitness_non_opt, ncol = 2, labels = c("A", ""), widths = c(1,2))
ggsave(here("figures/report18/si_ci_comp.png"), width = 12.5, height = 10)
```

#----------------------------------------_#
# figures plotting: co-invasion competition
#-----------------------------------------#
# Heatmap with optimized co-infection strategy agianst each other (static)
```{r}
# read in csv
ci_comp_static.df <- read.csv(here("data/ci_comp_static.csv"))

ci_comp_static.df <- select(ci_comp_static.df, id_1_alt, id_2_alt, fitness_diff)

# get reverse. Here, we will simply multiple fitness difference by -1
ci_comp_static.df2 <- select(ci_comp_static.df, id_1_alt, id_2_alt, fitness_diff)
names(ci_comp_static.df2) <- c("id_2_alt", "id_1_alt","fitness_diff")
ci_comp_static.df2$fitness_diff <- ci_comp_static.df$fitness_diff*-1

# cat
ci_comp_static.df3 <- rbind(select(ci_comp_static.df, id_1_alt, id_2_alt, fitness_diff),
                            select(ci_comp_static.df2, id_1_alt, id_2_alt, fitness_diff))


# Heatmap
ci_comp_static.pl1 <- ggplot(data = ci_comp_static.df3, aes(x = id_2_alt, y = id_1_alt, fill = fitness_diff))+
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "#fc8d59", high = "#4575b4", mid = "white", 
   midpoint = 0, space = "Lab", lim = c(-1.1, 1.5), name="Fitness\ndifference") +
  theme_minimal() +  
  theme(legend.position = "left",
  axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank(),
  text = element_text(size = 15),
  axis.ticks = element_blank(),
  plot.margin=margin(r = 0)) + 
  labs(x = "Strain 2 cue", y = "Strain 1 cue") +
  coord_fixed()

# do mean
ci_comp_static.mean <- ci_comp_static.df3 %>% 
  group_by(id_1_alt) %>% 
  summarize(mean = mean(fitness_diff, na.rm = T))


ci_comp_static.pl2 <- ggplot() +
  geom_bar(data =  ci_comp_static.mean, aes(y = id_1_alt, x = mean), stat = "identity") +
  labs(y = "", x = "Mean fitness\ndifference") +
  theme_bw() +
  theme(plot.margin = margin(l = 0),
       panel.grid.major = element_blank(),
  panel.background = element_blank(),
  text = element_text(size = 15),
    axis.text.y=element_blank(),
    axis.ticks.y=element_blank())
  

ci_static.pl <- ggarrange(ci_comp_static.pl1, ci_comp_static.pl2, align = "h", widths = c(1, 0.2))
ggsave(here("figures/report19/ci_comp_static.png"), width = 10)
```







