---
title: "R Notebook"
output: html_notebook
---
```{r}
library(dplyr)
library(ggplot2)
library(here)
library(deSolve)
library(crone)
library(optimParallel)
library(doParallel)
library(doRNG)
library(arrow)
library(stringr)
library(parallel)
library(ggpubr)
```

```{r}
source(here("functions/chabaudi_si_clean.R"))
```

Resolving single infection optimization
Previous attempts at optimization resulted in an infection curve that went unresolved. Here, I cannot get the infection period to resolve. Increasing the infection period causes the infection dynamic of the parasite to become flattened. 
```{r}
time_range <- seq(0, 30, by = 1e-3)
```

```{r}
source(here("functions/par_to_df.R"))
source(here("functions/chabaudi_si_clean.R"))

parameters_tsukushi <- c(R1 = 8.89*10^6, # slightly higher
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 8*10^-6, # doubled form original
                alpha = 1, 
                alphag = 2, 
                beta = 5.721, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1,
                psin = 16.69234,
                psiw = 0.8431785,
                phin = 0.03520591, 
                phiw = 550.842,
                iota = 2.18*(10^6),
                rho = 0.2627156)

```

```{r}
opt_local <- function(
  par, # initial parameter sets
  cue, #
  log,
  cue_range,
  dyn = F
  ){
  # start cluster
  cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
  
  # start optimization LFBGS
  res <- optimParallel(
    par = par,
    fn = chabaudi_si_clean, 
    control = list(trace = 6, fnscale = -1),
    immunity = "tsukushi",
    parameters = parameters_tsukushi,
    time_range = time_range,
    cue = cue,
    log_cue = log,
    cue_range = cue_range,
    solver = "vode")
  
  # close cluster
  stopCluster(cl)
  
  return (res)
}
```

# I non-logged
```{r}
I_loc.op <- opt_local(par = rep(0.5, 4),
                            cue = "I",
                            log = "none",
                            cue_range = seq(0, 6*(10^6), by = (6*(10^6))/5000))

I_loc_20.dyn <- chabaudi_si_clean(parameters_cr = c(0.1135384,  -39.0585154, 1941.9082813,  119.8228980),
                               parameters= parameters_tsukushi,
                               immunity = "tsukushi",
                               time_range = seq(0,25,0.001),
                               cue = "I",
                               log_cue = "none",
                               cue_range = seq(0, 6*(10^6), by = (6*(10^6))/5000),
                               dyn = T)

I_loc_25.dyn <- chabaudi_si_clean(parameters_cr = c(-0.4002295,  3.2517089,  0.6089734,  0.4916482),
                               parameters= parameters_tsukushi,
                               immunity = "tsukushi",
                               time_range = seq(0,25,0.001),
                               cue = "I",
                               log_cue = "none",
                               cue_range = seq(0, 6*(10^6), by = (6*(10^6))/5000),
                               dyn = T)

I_loc_30.dyn <- chabaudi_si_clean(parameters_cr = c(-0.4632307,  -12.7384555, 1898.9561735, -292.2138265),
                               parameters= parameters_tsukushi,
                               immunity = "tsukushi",
                               time_range = seq(0,30,0.001),
                               cue = "I",
                               log_cue = "none",
                               cue_range = seq(0, 6*(10^6), by = (6*(10^6))/5000),
                               dyn = T)

# 20 days optimziation
#0.1135384  -39.0585154 1941.9082813  119.8228980
#8.49777

# 25 days 
#-0.4002295  3.2517089  0.6089734  0.4916482
#9.860488

# 30 days
#-0.4632307  -12.7384555 1898.9561735 -292.2138265
#11.81462

# plotting together, we cannot get the infeciton cycle to resolve. By elongating the infection period, we see a flattening of parasite dynamics that prolongs the infection
ggplot()+ 
  geom_line(data = I_loc_30.dyn, aes(x = time, y = value, color = "30")) +
  geom_line(data = I_loc_25.dyn, aes(x = time, y = value, color = "25")) +
  geom_line(data = I_loc_20.dyn, aes(x = time, y = value, color = "20")) +
  facet_wrap(~variable, scales = "free") +
  theme_bw()
```

# I logged
Still no full resolution even with 30 days, although it is closer to resolution than 20 days optimization. Extending the simulation to 25 days allows the optimum 20 days to fully resolve. Hence, for future purposes, it might be better to optimize based on 20 days for optimal acute infection. However, for simulation go to 30 days to ensure fulll resolution 
```{r}
I_log_loc.op <- opt_local(par = rep(0.5, 4),
                            cue = "I",
                            log = "log10",
                            cue_range = seq(0, log10(6*(10^6)), by = (log10(6*(10^6)))/5000))

# 20 days
#5.463558   2.383948 -17.757281   4.571835
#9.494991

# 30 days
# 3.53672545  -0.03564319 -12.38102999   5.20523629
# 13.27947
I_log_loc_20.dyn <- chabaudi_si_clean(parameters_cr = c(5.463558,   2.383948 ,-17.757281 ,  4.571835),
                               parameters= parameters_tsukushi,
                               immunity = "tsukushi",
                               time_range = seq(0,30,0.001),
                               cue = "I",
                               log_cue = "log10",
                               cue_range = seq(0, log10(6*(10^6)), by = (log10(6*(10^6)))/5000),
                               dyn = T)

I_log_loc_30.dyn <- chabaudi_si_clean(parameters_cr = c(3.53672545,  -0.03564319, -12.38102999,   5.20523629),
                               parameters= parameters_tsukushi,
                               immunity = "tsukushi",
                               time_range = seq(0,30,0.001),
                               cue = "I",
                               log_cue = "log10",
                               cue_range = seq(0, log10(6*(10^6)), by = (log10(6*(10^6)))/5000),
                               dyn = T)

ggplot()+ 
  geom_line(data = I_log_loc_30.dyn, aes(x = time, y = value, color = "30")) +
  geom_line(data = I_log_loc_20.dyn, aes(x = time, y = value, color = "20")) +
  facet_wrap(~variable, scales = "free") +
  theme_bw()
```


#---------------------------------------------------------#
# Co-infection optimization
#---------------------------------------------------------#
```{r}
source(here("functions/par_to_df.R"))
source(here("functions/chabaudi_si_clean.R"))
source(here("functions/chabaudi_ci_clean.R"))
parameters_tsukushi <- c(R1 = 8.89*10^6, # slightly higher
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 8*10^-6, # doubled form original
                alpha = 1, 
                alphag = 2, 
                beta = 5.721, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1,
                psin = 16.69234,
                psiw = 0.8431785,
                phin = 0.03520591, 
                phiw = 550.842,
                iota = 2.18*(10^6),
                rho = 0.2627156)

time_range <- seq(0, 20, by = 1e-3)
```

#---------------------------------#
# confirming coinfection optimal strategy
#---------------------------------#
hard to do global optimization on coinfection optimization. One way to see whether our guesses are good is to compete our optimal conversion rate strategy with a bunch 

#---------------------------------#
# visualization co-infection strategy
#---------------------------------#
for all co-infection, optimized for 20 days. certain cues, I1+I2 and Ig1+Ig2 none-logged exhibit cyclical pattern and is omitted from subsequent analysis

All dynamics is simulated for 30 days to ensure that transmission acrrument is over

#
```{r}
# import in ci optimum for same cue
ci_opt.df <- read.csv(here("data/ci_opt.csv"))

# reclass for better labels
ci_opt.df <- ci_opt.df %>% 
  mutate(label_1 = case_when(
  cue == "I-i" ~ "Asexual iRBC",
  cue == "I1+I2" ~ "Total asexual\niRBC",
  cue == "Ig-i" ~ "Sexual iRBC",
  cue == "Ig1+Ig2" ~ "Total sexual\niRBC",
  cue == "sum" ~ "Total iRBC",
  cue == "G-i" ~ "Gametocyte",
  cue == "G1+G2" ~ "Total\ngametocyte",
  cue == "R" ~ "RBC"
)) %>% 
  mutate(label_2 = case_when(
    log == "log" ~ "log10",
    log == "none" ~ ""
  )) %>% 
  mutate(label_3 = paste(label_1, label_2),
         id = paste0(cue, "_", log))

# left join with cue range df
cue_range.df <- read.csv(here("data/cue_range.csv"))

ci_opt.df <- ci_opt.df %>% left_join(select(cue_range.df, low, high, by, id), by = c("id" = "id"))
```

# get conversion rate reaction norm
# altering code from report 17 for double strains. 30 days simulated
```{r}
heaviside_trans <- function(cue_range, max){
  res <- crone::heaviside(cue_range)*(cue_range)+(crone::heaviside(cue_range-max)*(max-cue_range))
  return(res)
}

get_dyn <- function(df){
  
  # read in df info
  if(stringr::str_detect(df$cue, "-i")){cue_1 = paste0(gsub("*-i", "", df$cue), "1")}
  if(stringr::str_detect(df$cue, "-i", negate = T)){cue_1 = df$cue}
  if(stringr::str_detect(df$cue, "-i")){cue_2 = paste0(gsub("*-i", "", df$cue), "2")}
  if(stringr::str_detect(df$cue, "-i", negate = T)){cue_2 = df$cue}
  if(stringr::str_detect(df$log, "log")){log_1 = "log10"}
  if(stringr::str_detect(df$log, "none")){log_1 = "none"}
  if(stringr::str_detect(df$log, "log")){log_2 = "log10"}
  if(stringr::str_detect(df$log, "none")){log_2 = "none"}
  par <- c(df$var1, df$var2, df$var3, df$var4)
  cue_range <- seq(df$low, df$high, by = df$by)
  label <- df$label_3
  
  # get dynamics
  dyn <- chabaudi_ci_clean(parameters_cr_1 = par,
                  parameters_cr_2 = par,
                  immunity = "tsukushi",
                  parameters = parameters_tsukushi,
                  cue_1 = cue_1,
                  cue_2 = cue_2,
                  cue_range_1 = cue_range,
                  cue_range_2 = cue_range,
                  log_cue_1 = log_1,
                  log_cue_2 = log_2,
                  solver = "vode",
                  time_range = seq(0, 30, 0.001),
                  dyn = T)
  
    dyn2 <- data.frame(dyn, label = rep(label, nrow(dyn)))

  # get reaction norm
  rn <- par_to_df(par = par, cue_range = cue_range)

  
  # get rug
  ## if + in cue, need to filter out those variables and add together
  if(stringr::str_detect(cue_1, "\\+")){
    cue_split <- stringr::str_split(string = cue_1, pattern = "\\+", simplify = T)
    ## get the two cues 
    cue_temp_1 <- cue_split[[1]]
    cue_temp_2 <- cue_split[[2]]
    
    ## filter dyn
    rug <- dyn2 %>% 
      filter(variable == cue_temp_1 | variable == cue_temp_2) %>% 
      dplyr::group_by(time) %>% 
      dplyr::mutate(sum = sum(value)) %>% 
      select(time, value = sum, label)
  }
  
  ## if sum
  if(cue_1 == "sum"){
    ## filter dyn
    rug <- dyn2 %>% 
      filter(variable == "I1" | variable == "I2" | variable == "Ig1" | variable == "Ig2") %>% 
      dplyr::group_by(time) %>% 
      dplyr::mutate(sum = sum(value)) %>% 
      select(time, value = sum, label)
  }
  
  # for simplified cue
  if(stringr::str_detect(cue_1, "\\+", negate = T) && cue_1 != "sum"){
    rug <- dyn2 %>% 
      dplyr::filter(variable == cue_1) %>% 
      dplyr::select(time, value, label)}
  
  # for logged, backtransform cue range of reaction norm 
  rn2 <- rn
  rn2$cue_range <- 10^(rn2$cue_range)
  
  # append label to reaction norm, dyn, and rug
  rn2 <- data.frame(rn2, label = rep(label, nrow(rn)))

  return(list(dyn2, rn2, rug))
}

```

```{r}
test <- dyn2 %>% 
      filter(variable == cue_temp_1 | variable == cue_temp_2) %>% 
      dplyr::group_by(time) %>% 
      dplyr::summarise(sum = sum(value)) %>% 
      select(time, value = sum) 

  
source(here("functions/chabaudi_ci_clean.R"))
test <- chabaudi_ci_clean(
  parameters_cr_1 = c(18.879767, -39.688967,   1.969041, -36.436620),
                  parameters_cr_2 = c(35.6294,	-65.6898,	-11.5609,	-52.0779),
                  immunity = "tsukushi",
                  parameters = parameters_tsukushi,
                  cue_1 = "Ig1",
                  cue_2 = "Ig2",
                  cue_range_1 = seq(0, log10(6*10^6), by = log10(6*10^6)/5000),
                  cue_range_2 = seq(0, log10(6*10^6), by = log10(6*10^6)/5000),
                  log_cue_1 = "log10",
                  log_cue_2 = "log10",
                  solver = "vode",
                  time_range = seq(0, 30, 0.001),
                  dyn = T)

test
ggplot() +
  geom_line(data = test, aes(x = time, y = value, color = strain)) +
  facet_wrap(~variable, scales = "free")
```

# loop through df to get reaction norm + dyn
```{r}
# split df 
ci_opt.ls <- split(ci_opt.df, seq(nrow(ci_opt.df)))

# parallelzed lapply
ci_opt.dyn <- mclapply(ci_opt.ls, get_dyn)

# bind together dynamics
dyn.ls <- lapply(ci_opt.dyn, function(x)x[[1]])
ci_dyn.df <- do.call(rbind, dyn.ls)

rn.ls <- lapply(ci_opt.dyn, function(x)x[[2]])
ci_rn.df <- do.call(rbind, rn.ls)

rug.ls <- lapply(ci_opt.dyn, function(x)x[[3]])
ci_rug.df <- do.call(rbind, rug.ls)
```


```{r}
# filter to restriction conversion rate reaction norm range to cue ranges that appear in rug
## change to Inf/-inf to NA
ci_rug_lim.df <- ci_rug.df %>% 
  group_by(label) %>% 
  summarise(min = min(value, na.rm = T)*0.9,
         max = max(value, na.rm = T)*1.1)

ci_rug_lim.df
ci_rug.df %>% filter(label == "Sexual iRBC log10") %>% summarize(max= max(value))
```

# visualization
```{r}
ggplot() +
  geom_line(data = ci_rn.df, aes(x = cue_range, y = cr)) +
  geom_rug(data = ci_rug.df, aes(x = value), color = "red") +
  facet_wrap(~label, scales = "free_x") +
  theme_bw() +
  labs(y = "Conversion rate", x = "Cue range") +
  scale_x_continuous(labels = function(x) format(x, scientific = FALSE),
                     guide = guide_axis(check.overlap = TRUE)) + 
                    theme(axis.text.x = element_text(size = 7)) 
```



#---------------------------------#
Competing co-infection STATIC
#---------------------------------#

fully static run with the optimal parameter for each cue competing against each other. parasites are not allowed to alter their strategy. In biology terms, think of when intrastrain competition>>interstrain competition, thereby maintaining the original optimizal parameters.

```{r}
source(here("functions/chabaudi_ci_clean.R"))
cue_range.df <- read.csv(here("data/cue_range.csv"))
```

# create cue_range df
if _i at end of cue, suggesting of I1/I2 (self-differentation possible).
```{r}
# code. 
cue_range.df <- cbind.data.frame(
  cue = c("I-i", "I-i",
          "I1+I2",
          "Ig-i", "Ig-i",
          "Ig1+Ig2",
          "sum", "sum",
          "G-i", "G-i",
          "G1+G2", "G1+G2",
          "R", "R"),
  log = c("none", "log",
          "log",
          "none", "log",
          "log",
          "none", "log",
          "none", "log",
          "none", "log",
          "none", "log"),
  low = c(0, 0,
          0,
          0, 0,
          0,
          0, 0,
          0, 0,
          0, 0,
          (10^6), log10(10^6)),
  high = c(6*(10^6), log10(6*(10^6)),
           log10(6*(10^6)),
           6*(10^6), log10(6*(10^6)),
           log10(6*(10^6)),
           6*(10^6), log10(6*(10^6)),
           6*(10^4), log10(6*(10^4)),
           6*(10^4), log10(6*(10^4)),
           (10^7), log10(10^7)),
  by = c((6*(10^6))/5000, (log10(6*(10^6)))/5000,
         (log10(6*(10^6)))/5000,
         (6*(10^6))/5000, (log10(6*(10^6)))/5000,
         (log10(6*(10^6)))/5000,
         (6*(10^6))/5000, (log10(6*(10^6)))/5000,
         (6*(10^4))/5000, (log10(6*(10^4)))/5000,
         (6*(10^4))/5000, (log10(6*(10^4)))/5000,
         ((10^7)-(10^6))/5000, (log10(10^7)-log10(10^6))/5000)
) %>% 
  mutate(id = paste0(cue, "_", log))

write.csv(cue_range.df, here("data/cue_range.csv"), row.names = F)
```

# check for time series to get time range. Using isolated asexual iRBC as subject
30 days is insufficient for full infection resolution but very little fitness is accrued at the end
```{r}
ci_I_i.dyn <- chabaudi_ci_clean(parameters_cr_1 = c(381.7701,-528.2317,-324.5508,-403.8235),
                  parameters_cr_2 = c(381.7701,-528.2317,-324.5508,-403.8235),
                  immunity = "tsukushi",
                  parameters = parameters_tsukushi,
                  cue_1 = "I1",
                  cue_2 = "I2",
                  cue_range_1 = seq(0, log10(6*(10^6))),
                  cue_range_2 = seq(0, log10(6*(10^6))),
                  log_cue_1 = "log10",
                  log_cue_2 = "log10",
                  solver = "vode",
                  time_range = seq(0,30,0.001),
                  dyn = T)
ggplot() +
  geom_line(data = test, aes(x = time, y = value, color = strain)) +
  facet_wrap(~variable_alt, scales = "free")+
  theme_bw()
```

# function to loop over strategy dataframe
```{r}
ci_comp_static <- function(df){
  
  # process cue. if detect _i, suggesting individual cue. 
  if(stringr::str_detect(df$cue, "-i")){cue_1 = paste0(gsub("*-i", "", df$cue), "1")}
  if(stringr::str_detect(df$cue, "-i", negate = T)){cue_1 = df$cue}
  
  if(stringr::str_detect(df$cue_2, "-i")){cue_2 = paste0(gsub("*-i", "", df$cue_2), "2")}
  if(stringr::str_detect(df$cue_2, "-i", negate = T)){cue_2 = df$cue_2}
  
  # process log10
  if(stringr::str_detect(df$log, "log")){log_1 = "log10"}
  if(stringr::str_detect(df$log, "none")){log_1 = "none"}
  
  if(stringr::str_detect(df$log_2, "log")){log_2 = "log10"}
  if(stringr::str_detect(df$log_2, "none")){log_2 = "none"}
  
  # get fitness difference between strain and strain 2 
  # simulated fort 30 days for transmission resolution (infectino may not resolve but transmission accumulation has halted)
  # past test suggests very little difference between 20 vs 30 days.
  fitness <- chabaudi_ci_clean(parameters_cr_1 = c(df$var1, df$var2, df$var3, df$var4),
                  parameters_cr_2 = c(df$var1_2, df$var2_2, df$var3_2, df$var4_2),
                  immunity = "tsukushi",
                  parameters = parameters_tsukushi,
                  cue_1 = cue_1,
                  cue_2 = cue_2,
                  cue_range_1 = seq(df$low, df$high, by = df$by),
                  cue_range_2 = seq(df$low_2, df$high_2, by = df$by_2),
                  log_cue_1 = log_1,
                  log_cue_2 = log_2,
                  solver = "vode",
                  time_range = seq(0, 30, 0.001))
  
  # return list
  return(list(df$id, df$id_2, fitness))
}
```


```{r}
# read in table of optimal parameter from co-infection (20 days period), but we will simulate for 30 days for transmission resolution
ci_opt.df <- read.csv(here("data/ci_opt.csv"))

# get unique id and join with cue range df
ci_cue.df <- ci_opt.df %>% 
  mutate(id = paste0(cue, "_", log)) %>% 
  left_join(select(cue_range.df, c(id, low, high, by)), by = c("id" = "id"))

# get all pairwise combinations
ci_cue_pair.df <- ci_cue.df %>% 
  setNames(paste0(names(ci_cue.df), '_2')) %>% 
  tidyr::crossing(ci_cue.df, .name_repair = "check_unique") %>% 
  janitor::clean_names()

# keep only unique pairwise combinations
ci_cue_pair.df2 <- ci_cue_pair.df[!duplicated(apply(select(ci_cue_pair.df, id, id_2), 1, function(x) paste(sort(x),collapse=''))),]

# split to list
ci_cue_pair.ls <- split(ci_cue_pair.df2, seq(nrow(ci_cue_pair.df2)))

# parallelized lapply
ci_comp_static <- mclapply(ci_cue_pair.ls, ci_comp_static)

# process data frame
ci_comp_static.df <- data.frame(do.call(rbind, lapply(ci_comp_static, unlist)))
names(ci_comp_static.df) <- c("id_1", "id_2", "fitness_diff")

# parse id to get cue and log status
ci_comp_static.df <- ci_comp_static.df %>% 
  mutate(
    cue_1 = gsub("-i.*", "", gsub("_.*", "", id_1)),
    cue_2 = gsub("-i.*", "", gsub("_.*", "", id_2)),
    log_1 = ifelse(str_detect(id_1, "log"), "log10", ""),
    log_2 = ifelse(str_detect(id_2, "log"), "log10", ""),
    id_1_alt = paste(cue_1, log_1),
    id_2_alt = paste(cue_2, log_2))

# write and import back
write.csv(ci_comp_static.df, here("data/ci_comp_static.csv"), row.names = F)
ci_comp_static.df <- read.csv(here("data/ci_comp_static.csv"))

ci_comp_static.df <- select(ci_comp_static.df, id_1_alt, id_2_alt, fitness_diff)
```

# visualize using heatmap
```{r}
# get reverse. Here, we will simply multiple fitness difference by -1
ci_comp_static.df2 <- select(ci_comp_static.df, id_1_alt, id_2_alt, fitness_diff)
names(ci_comp_static.df2) <- c("id_2_alt", "id_1_alt","fitness_diff")
ci_comp_static.df2$fitness_diff <- ci_comp_static.df2$fitness_diff*-1

# cat
ci_comp_static.df3 <- rbind(select(ci_comp_static.df, id_1_alt, id_2_alt, fitness_diff), ci_comp_static.df2) %>% 
  group_by(id_1_alt) %>% 
  mutate(mean = mean(fitness_diff))

# Heatmap
ci_comp_static.map <- ggplot(data = ci_comp_static.df3, aes(x = id_2_alt, y = id_1_alt, fill = fitness_diff))+
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "red", high = "blue", mid = "white", 
   midpoint = 0, space = "Lab", limits = c(-2.8, 2.8), name="Fitness\ndifference") +
  theme_minimal() +  
  theme(legend.position="none",
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
  panel.grid.major = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank(),
  axis.ticks = element_blank(),
  plot.margin=unit(c(1,-2.5,1,1), "cm"),
  legend.direction = "horizontal") +
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                title.position = "top", title.hjust = 0.5)) +
  labs(x = "Strain 2 cue", y = "Strain 1 cue") +
 coord_fixed()

# get mean
ci_comp_static.mean <- ggplot() +
  geom_tile(data = ci_comp_static.df3, aes(y = id_1_alt, x = 1, fill = mean),
           stat = "identity", color = "black") +
  labs(x = "", y = "") +
  scale_fill_gradient2(low = "red", high = "blue", mid = "white", 
   midpoint = 0, space = "Lab", limits = c(-2.8, 2.8), name="Fitness\ndifference") +
  theme_bw() +
  theme(
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank(),
    axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        plot.margin=unit(c(1,1,1,-1.5), "cm"))
  
ggarrange(ci_comp_static.map, ci_comp_static.mean, align = "h", widths = c(1, 0.2))
ggsave(here("figures/report18/ci_comp_static.png"), width = 10.5)
```

