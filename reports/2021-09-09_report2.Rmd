---
title: "2021-09-09_report2"
output: html_document
---

# Loading libraries
```{r}
library(deSolve)
library(optimParallel)
library(ggplot2)
library(magrittr)
library(ggpubr)
```

# loading functions
```{r}
setwd("/Users/avrilwang/Desktop/Project-Plasmodium/functions")
source("par_to_df.R")
source("chabaudi_si_opt_fast.R")

setwd("/Users/avrilwang/Desktop/Project_Plasmodium/functions")
source("par_to_df.R")
source("chabaudi_si_opt_fast.R")
source("chabaudi_si_opt_lag.R")
```
#--------------------#
# Replicating Greischar model
# with saturating immunity (Figure 1)
#--------------------#
# define time range
```{r}
time_range <- seq(0, 20, by = 1e-3)
```

# define cye range
```{r}
# maximum infected RBC by Tsukushi's dosage paper (maximum infected RBC based on experimental results)
I_range <- seq(0, 2.18*10^6, by = 1000)
```


```{r}
parameters <- c(R1 = 8.5*10^6,
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 4*10^-6,
                alpha = 1, 
                alphag = 2, 
                beta = 10, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1)

cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
ch_si_t_20.opt_i <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_fast, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "t",
                      cue_range = time_range,
                      solver = "vode")
stopCluster(cl)

ch_si_t_20.opt_i$par #13.684281 -28.161346  -3.578826 -20.693335. Very close to Greischar
ch_si_t_20.opt_i$value #11.4814

# get infection dynamics
ch_si_t_20.dyn_i <- chabaudi_si_opt_fast(
  parameters_cr = ch_si_t_20.opt_i$par,
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "t",
  cue_range = time_range,
  solver = "vode",
  dyn = TRUE)

# simulate infection dynamics using Greischar's parameters
greischar.dyn_i <- chabaudi_si_opt_fast(
  parameters_cr = c(13.46, -27.66, -3.62, -20.24),
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "t",
  cue_range = time_range,
  solver = "vode",
  dyn = TRUE)

# success!
colors <- c("My model" = "blue", "Greischar's model" = "red")

ggplot() +
  geom_line(data = ch_si_t_20.dyn_i, aes(x = time, y = value, color = "My model"), alpha = 0.6) +
  geom_line(data = greischar.dyn_i, aes(x = time, y = value, color = "Greischar's model"), alpha = 0.6) +
  facet_wrap(~variable, scales = "free") +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "Legend") +
  scale_color_manual(values = colors) +
  theme_bw()

setwd("/Users/avrilwang/Desktop/Project_Plasmodium/figures/report2")
ggsave("replicate_sat_immunity.png", width = 7, height = 5)
```

#--------------------#
# Test effects of lag model (Figure 3)
#--------------------#
Seeing if introducing lag between conversion rate decision and infected RBC production leads to different conversion rate strategy.

# time based cr
```{r}
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_t_20.opt_i <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "t",
                      cue_range = time_range,
                      solver = "vode")
stopCluster(cl)

lag_si_t_20.opt_i$par #9.676618 -22.741734   1.700253 -19.323945
lag_si_t_20.opt_i$value #11.48145

lag_si_t_20.dyn_i <- chabaudi_si_opt_lag(
  parameters_cr = lag_si_t_20.opt_i$par,
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "t",
  cue_range = time_range,
  solver = "vode",
  dyn = TRUE)

# same dynamics for time based
colors_fig3A <- c("Non-lag model" = "blue", "Lag model"= "red")

fig3A <- ggplot() +
  geom_line(data = lag_si_t_20.dyn_i, aes(x = time, y = value, color = "Lag model"), alpha = 0.6) +
  geom_line(data = ch_si_t_20.dyn_i, aes(x = time, y = value, color = "Non-lag model"), alpha = 0.6) +
  facet_wrap(~variable, scales = "free") +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "Legend") +
  scale_color_manual(values = colors_fig3A) +
  theme_bw()
```

# infected RBC based cr
```{r}
# not lagged. Did not converge
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
ch_si_I_20.opt_i <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_fast, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range,
                      solver = "vode")
stopCluster(cl)

# lagged. Converged
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_i <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range,
                      solver = "vode")
stopCluster(cl)

ch_si_I_20.opt_i$par # 1.871096 -42.642681   4.033986 -35.841590
ch_si_I_20.opt_i$value  #11.19807

lag_si_I_20.opt_i$par  # 1.31331 -37.34658 341.63819  73.72398
lag_si_I_20.opt_i$value  #10.88715. Lower than the non-lag model. 

# infection dynamics
ch_si_I_20.dyn_i <- chabaudi_si_opt_fast(
  parameters_cr = ch_si_I_20.opt_i$par,
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "I",
  cue_range = I_range,
  solver = "vode",
  dyn = TRUE)

lag_si_I_20.dyn_i <- chabaudi_si_opt_lag(
  parameters_cr = lag_si_I_20.opt_i$par,
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "I",
  cue_range = I_range,
  solver = "vode",
  dyn = TRUE)

# plot. Very different!
fig3B <- ggplot() +
  geom_line(data = lag_si_I_20.dyn_i, aes(x = time, y = value, color = "Lag model"), alpha = 0.6) +
  geom_line(data = ch_si_I_20.dyn_i, aes(x = time, y = value, color = "Non-lag model"), alpha = 0.6) +
  facet_wrap(~variable, scales = "free") +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "Legend") +
  scale_color_manual(values = colors_fig3A) +
  theme_bw()
```

# plot together
```{r}
ggarrange(fig3A, fig3B, align = "hv", ncol = 1, common.legend = TRUE, labels = c("A", "B"))

setwd("/Users/avrilwang/Desktop/Project_Plasmodium/figures/report2")
ggsave("lag_model_diff.png", width = 7, height = 7)
```


#--------------------#
# Run time-based cues with
# different innate immunity models
#--------------------#
# original model
```{r}
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
ch_si_i_t_20.opt <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "t",
                      cue_range = time_range,
                      solver = "vode")
stopCluster(cl)

# converged
ch_si_i_t_20.opt$par  #7.708424 -19.252262   2.682587 -16.857024
ch_si_i_t_20.opt$value #11.96679

ch_si_i_t_20.dyn <- chabaudi_si_opt_lag(
  parameters_cr = ch_si_i_t_20.opt$par,
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "t",
  cue_range = time_range,
  solver = "vode",
  dyn = TRUE,
  integration = "trapezoid")
```

# Kochins
```{r}
parameters_kochin <- c(R1 = 8.89*10^6,
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 4*10^-6,
                alpha = 1, 
                alphag = 2, 
                beta = 10, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1,
                sigma = 1.17*10^-8,
                mue = 0.3,
                gamma = 133)

cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
ch_si_i_t_20.opt_kochin <- optimParallel(par = c(0.5,0.5,0.5,0.5),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "kochin",
                      parameters = parameters_kochin,
                      time_range = time_range,
                      df = 3,
                      cue = "t",
                      cue_range = time_range,
                      solver = "vode",
                      integration = "simpson")
stopCluster(cl)

## converged
ch_si_i_t_20.opt_kochin$par  #3.941907 -12.105016   4.385514 -11.371876
ch_si_i_t_20.opt_kochin$value #13.01394

ch_si_i_t_20.dyn_kochin <- chabaudi_si_opt_lag(
  parameters_cr = ch_si_i_t_20.opt_kochin$par,
  immunity = "kochin",
  parameters = parameters_kochin,
  time_range = time_range,
  df = 3,
  cue = "t",
  cue_range = time_range,
  solver = "vode",
  dyn = TRUE,
  integration = "trapezoid")


```

# Kamiya
```{r}
parameters_tsukushi <- c(R1 = 8.89*10^6, # slightly higher
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 8*10^-6, # doubled form original
                alpha = 1, 
                alphag = 2, 
                beta = 5.721, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1,
                psin = 16.69234,
                psiw = 0.8431785,
                phin = 0.03520591, 
                phiw = 550.842,
                iota = 2.18*(10^6),
                rho = 0.2627156)

cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
ch_si_i_t_20.opt_tsukushi <- optimParallel(par = c(0.5, 0.5, 0.5, 0.5),
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "tsukushi",
                      parameters = parameters_tsukushi,
                      time_range = time_range,
                      df = 3,
                      cue = "t",
                      cue_range = time_range,
                      solver = "vode",
                      integration = "trapezoid")
stopCluster(cl)

# not converged!
ch_si_i_t_20.opt_tsukushi$par  #4.311945 -12.460638   4.141877 -11.788003
ch_si_i_t_20.opt_tsukushi$value #9.081061

ch_si_i_t_20.dyn_tsukushi <- chabaudi_si_opt_lag(
  parameters_cr = ch_si_i_t_20.opt_tsukushi$par,
  immunity = "tsukushi",
  parameters = parameters_tsukushi,
  time_range = time_range,
  df = 3,
  cue = "t",
  cue_range = time_range,
  solver = "vode",
  dyn = TRUE,
  integration = "trapezoid")
```

# plot together
```{r}
ggplot() +
  geom_line(data = ch_si_i_t_20.dyn, aes(x = time, y = value), color = "black") +
  geom_line(data = ch_si_i_t_20.dyn_kochin, aes(x = time, y = value), color = "blue") +
  geom_line(data = ch_si_i_t_20.dyn_tsukushi, aes(x = time, y = value), color = "red") +
  facet_wrap(~variable, scales = "free") +
  theme_bw()

setwd("/Users/avrilwang/Desktop/Project_Plasmodium/figures/report2")
ggsave("innate_immunity_time.png")
```

