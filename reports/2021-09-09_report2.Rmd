---
title: "2021-09-09_report2"
output: html_document
---

# Loading libraries
```{r}
library(deSolve)
library(optimParallel)
library(ggplot2)
library(magrittr)
library(ggpubr)
```

# loading functions
```{r}
setwd("/Users/avrilwang/Desktop/Project-Plasmodium/functions")
source("par_to_df.R")
source("chabaudi_si_opt_fast.R")

setwd("/Users/avrilwang/Desktop/Project_Plasmodium/functions")
source("par_to_df.R")
source("chabaudi_si_opt_fast.R")
source("chabaudi_si_opt_lag.R")
```
#--------------------#
# Replicating Greischar model
# with saturating immunity (Figure 1)
#--------------------#
# define time range
```{r}
time_range <- seq(0, 20, by = 1e-3)
```

# define cye range
```{r}
# maximum infected RBC by Tsukushi's dosage paper (maximum infected RBC based on experimental results)
I_range <- seq(0, 2.18*10^6, by = 1000)
```


```{r}
parameters <- c(R1 = 8.5*10^6,
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 4*10^-6,
                alpha = 1, 
                alphag = 2, 
                beta = 10, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1)

cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
ch_si_t_20.opt_i <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_fast, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "t",
                      cue_range = time_range,
                      solver = "vode")
stopCluster(cl)

ch_si_t_20.opt_i$par #13.684281 -28.161346  -3.578826 -20.693335. Very close to Greischar
ch_si_t_20.opt_i$value #11.4814

# get infection dynamics
ch_si_t_20.dyn_i <- chabaudi_si_opt_fast(
  parameters_cr = ch_si_t_20.opt_i$par,
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "t",
  cue_range = time_range,
  solver = "vode",
  dyn = TRUE)

# simulate infection dynamics using Greischar's parameters
greischar.dyn_i <- chabaudi_si_opt_fast(
  parameters_cr = c(13.46, -27.66, -3.62, -20.24),
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "t",
  cue_range = time_range,
  solver = "vode",
  dyn = TRUE)

# success!
colors <- c("My model" = "blue", "Greischar's model" = "red")

ggplot() +
  geom_line(data = ch_si_t_20.dyn_i, aes(x = time, y = value, color = "My model"), alpha = 0.6) +
  geom_line(data = greischar.dyn_i, aes(x = time, y = value, color = "Greischar's model"), alpha = 0.6) +
  facet_wrap(~variable, scales = "free") +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "Legend") +
  scale_color_manual(values = colors) +
  theme_bw()

setwd("/Users/avrilwang/Desktop/Project_Plasmodium/figures/report2")
ggsave("replicate_sat_immunity.png", width = 7, height = 5)
```

#--------------------#
# Test effects of lag model (Figure 3)
#--------------------#
Seeing if introducing lag between conversion rate decision and infected RBC production leads to different conversion rate strategy.

# time based cr
```{r}
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_t_20.opt_i <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "t",
                      cue_range = time_range,
                      solver = "vode")
stopCluster(cl)

lag_si_t_20.opt_i$par #9.676618 -22.741734   1.700253 -19.323945
lag_si_t_20.opt_i$value #11.48145

lag_si_t_20.dyn_i <- chabaudi_si_opt_lag(
  parameters_cr = lag_si_t_20.opt_i$par,
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "t",
  cue_range = time_range,
  solver = "vode",
  dyn = TRUE)

# same dynamics for time based
colors_fig3A <- c("Non-lag model" = "blue", "Lag model"= "red")

fig3A <- ggplot() +
  geom_line(data = lag_si_t_20.dyn_i, aes(x = time, y = value, color = "Lag model"), alpha = 0.6) +
  geom_line(data = ch_si_t_20.dyn_i, aes(x = time, y = value, color = "Non-lag model"), alpha = 0.6) +
  facet_wrap(~variable, scales = "free") +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "Legend") +
  scale_color_manual(values = colors_fig3A) +
  theme_bw()
```

# infected RBC based cr
```{r}
# not lagged. Did not converge
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
ch_si_I_20.opt_i <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_fast, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range,
                      solver = "vode")
stopCluster(cl)

# lagged. Converged
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_i <- optimParallel(par = rep(0.5,4),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range,
                      solver = "vode")
stopCluster(cl)

ch_si_I_20.opt_i$par # 1.871096 -42.642681   4.033986 -35.841590
ch_si_I_20.opt_i$value  #11.19807

lag_si_I_20.opt_i$par  # 1.31331 -37.34658 341.63819  73.72398
lag_si_I_20.opt_i$value  #10.88715. Lower than the non-lag model. 

# infection dynamics
ch_si_I_20.dyn_i <- chabaudi_si_opt_fast(
  parameters_cr = ch_si_I_20.opt_i$par,
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "I",
  cue_range = I_range,
  solver = "vode",
  dyn = TRUE)

lag_si_I_20.dyn_i <- chabaudi_si_opt_lag(
  parameters_cr = lag_si_I_20.opt_i$par,
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "I",
  cue_range = I_range,
  solver = "vode",
  dyn = TRUE)

# plot. Very different!
fig3B <- ggplot() +
  geom_line(data = lag_si_I_20.dyn_i, aes(x = time, y = value, color = "Lag model"), alpha = 0.6) +
  geom_line(data = ch_si_I_20.dyn_i, aes(x = time, y = value, color = "Non-lag model"), alpha = 0.6) +
  facet_wrap(~variable, scales = "free") +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "Legend") +
  scale_color_manual(values = colors_fig3A) +
  theme_bw()
```

# plot together
```{r}
ggarrange(fig3A, fig3B, align = "hv", ncol = 1, common.legend = TRUE, labels = c("A", "B"))

setwd("/Users/avrilwang/Desktop/Project_Plasmodium/figures/report2")
ggsave("lag_model_diff.png", width = 7, height = 7)
```


#--------------------#
# Effects of different innate immunity functions
# Figure 4
#--------------------#
# Kochins times
```{r}
parameters_kochin <- c(R1 = 8.89*10^6,
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 4*10^-6,
                alpha = 1, 
                alphag = 2, 
                beta = 10, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1,
                sigma = 1.17*10^-8,
                mue = 0.3,
                gamma = 133)

cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_t_20.opt_kochin <- optimParallel(par = c(0.5,0.5,0.5,0.5),# new parameter search space
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "kochin",
                      parameters = parameters_kochin,
                      time_range = time_range,
                      df = 3,
                      cue = "t",
                      cue_range = time_range,
                      solver = "vode")
stopCluster(cl)

## converged
lag_si_t_20.opt_kochin$par  #3.960522 -12.107302   4.065275 -10.841533
lag_si_t_20.opt_kochin$value #13.05322

lag_si_t_20.dyn_kochin <- chabaudi_si_opt_lag(
  parameters_cr = lag_si_t_20.opt_kochin$par,
  immunity = "kochin",
  parameters = parameters_kochin,
  time_range = time_range,
  df = 3,
  cue = "t",
  cue_range = time_range,
  solver = "vode",
  dyn = TRUE)
```

# Kamiya times
```{r}
parameters_tsukushi <- c(R1 = 8.89*10^6, # slightly higher
                lambda = 3.7*10^5,
                mu = 0.025, 
                p = 8*10^-6, # doubled form original
                alpha = 1, 
                alphag = 2, 
                beta = 5.721, 
                mum = 48, 
                mug = 4, 
                I0 = 43.85965, 
                Ig0 = 0, 
                a = 150, 
                b = 100, 
                sp = 1,
                psin = 16.69234,
                psiw = 0.8431785,
                phin = 0.03520591, 
                phiw = 550.842,
                iota = 2.18*(10^6),
                rho = 0.2627156)

cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_t_20.opt_tsukushi <- optimParallel(par = c(0.5, 0.5, 0.5, 0.5),
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "tsukushi",
                      parameters = parameters_tsukushi,
                      time_range = time_range,
                      df = 3,
                      cue = "t",
                      cue_range = time_range,
                      solver = "vode")
stopCluster(cl)

# converged
lag_si_t_20.opt_tsukushi$par  #4.561687 -13.025658   4.161285 -11.963527
lag_si_t_20.opt_tsukushi$value #9.787899

lag_si_t_20.dyn_tsukushi <- chabaudi_si_opt_lag(
  parameters_cr = lag_si_t_20.opt_tsukushi$par,
  immunity = "tsukushi",
  parameters = parameters_tsukushi,
  time_range = time_range,
  df = 3,
  cue = "t",
  cue_range = time_range,
  solver = "vode",
  dyn = TRUE)
```

# Kochin infected RBC
```{r}
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_kochin <- optimParallel(par = c(0.9060162,  -55.3933591, 1065.6352372, 31.4803195),
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "kochin",
                      parameters = parameters_kochin,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range,
                      solver = "vode")
stopCluster(cl)

# Did not converge! repeat with current value. Converged after
lag_si_I_20.opt_kochin$par #0.9060162  -55.3933591 1065.6352372, 31.4803195
# 0.9060127  -55.3933591 1065.6352372   31.4803195
lag_si_I_20.opt_kochin$value #12.68539
#12.68539 (no change lol)

lag_si_I_20.dyn_kochin <- chabaudi_si_opt_lag(
  parameters_cr = lag_si_I_20.opt_kochin$par,
  immunity = "kochin",
  parameters = parameters_kochin,
  time_range = time_range,
  df = 3,
  cue = "I",
  cue_range = I_range,
  solver = "vode",
  dyn = TRUE)
```


# Kamiya infected RBC
```{r}
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_tsukushi <- optimParallel(par = c(0.2588562, -26.8194060, 601.1017562,23.1934922),
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "tsukushi",
                      parameters = parameters_tsukushi,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range,
                      solver = "vode")
stopCluster(cl)

# did not converge first time. Rerun with 1st parameters. Converged second time
lag_si_I_20.opt_tsukushi$par #0.2588562 -26.8194060 601.1017562  23.1934922
#0.2588557 -26.8194060 601.1017562  23.1934922
lag_si_I_20.opt_tsukushi$value #8.720535 #8.720535

lag_si_I_20.dyn_tsukushi <- chabaudi_si_opt_lag(
  parameters_cr = lag_si_I_20.opt_tsukushi$par,
  immunity = "tsukushi",
  parameters = parameters_tsukushi,
  time_range = time_range,
  df = 3,
  cue = "I",
  cue_range = I_range,
  solver = "vode",
  dyn = TRUE)
```

# plot together
```{r}
# color 
colors_fig4 <- c("Saturating immunity" = "black",
                  "Kochin" = "blue",
                  "Kamiya" = "red")

# plot of time-based conversion rate strategy
innate_immunity_t <- ggplot() +
  geom_line(data = lag_si_t_20.dyn_i, aes(x = time, y = value, color = "Saturating immunity")) +
  geom_line(data = lag_si_t_20.dyn_kochin, aes(x = time, y = value, color = "Kochin")) +
  geom_line(data = lag_si_t_20.dyn_tsukushi, aes(x = time, y = value, color="Kamiya")) +
  facet_wrap(~variable, scales = "free") +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "Legend") +
  scale_color_manual(values = colors_fig4) +
  theme_bw()


#plot of infected RBC-based conversion rate strategy
innate_immunity_I <- ggplot() +
  geom_line(data = lag_si_I_20.dyn_i, aes(x = time, y = value, color = "Saturating immunity")) +
  geom_line(data = lag_si_I_20.dyn_kochin, aes(x = time, y = value, color = "Kochin")) +
  geom_line(data = lag_si_I_20.dyn_tsukushi, aes(x = time, y = value, color="Kamiya")) +
  facet_wrap(~variable, scales = "free") +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "Legend") +
  scale_color_manual(values = colors_fig4) +
  theme_bw()

ggarrange(innate_immunity_t, innate_immunity_I, align = "hv", ncol = 1, common.legend = TRUE, labels = c("A", "B"))

setwd("/Users/avrilwang/Desktop/Project_Plasmodium/figures/report2")
ggsave("innate_immunity_t_I.png", width = 7, height = 10)
```


#--------------------#
# Effects of different transformation methods
# Figure 5A
#--------------------#
# using infected RBC as test
```{r}
# normalization
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_i_norm <- optimParallel(par = c(0.4979002,  1.1183273, -0.7884541,  0.4170063),
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range,
                      solver = "vode",
                      transformation = "norm")
stopCluster(cl)

### not convergred. Did not converge 2nd time
lag_si_I_20.opt_i_norm$par # 0.4979002  1.1183273 -0.7884541  0.4170063
lag_si_I_20.opt_i_norm$value #10.59145

lag_si_I_20.dyn_i_norm <- chabaudi_si_opt_lag(
  parameters_cr = lag_si_I_20.opt_i_norm$par,
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "I",
  cue_range = I_range,
  solver = "vode",
  dyn = TRUE,
  transformation = "norm")

# logistics
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_i_logit <- optimParallel(par = c(-3.114123,   66.052549, -624.723920,  -57.021729),
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range,
                      solver = "vode",
                      transformation = "logit")
stopCluster(cl)
lag_si_I_20.opt_i_logit$par #-2.951903   59.704033 -527.379250  -59.785296
#-3.114123   66.052549 -624.723920  -57.021729
lag_si_I_20.opt_i_logit$value #10.66487 higher (lower than exp) ## did not converge though
# 10.70449


lag_si_I_20.dyn_i_logit <- chabaudi_si_opt_lag(
  parameters_cr = lag_si_I_20.opt_i_logit$par,
  immunity = "i",
  parameters = parameters,
  time_range = time_range,
  df = 3,
  cue = "I",
  cue_range = I_range,
  solver = "vode",
  dyn = TRUE,
  transformation = "logit")

lag_si_I_20.opt_i
```

# plot together
```{r}
# get cr curve
lag_si_I_20.cr_i <- par_to_df(lag_si_I_20.opt_i$par, I_range)
lag_si_I_20.cr_i_norm <- par_to_df(lag_si_I_20.opt_i_norm$par, I_range, transformation = "norm")
lag_si_I_20.cr_i_logit <- par_to_df(lag_si_I_20.opt_i_logit$par, I_range, transformation = "logit")

# plot infection dynamics
ggplot() +
  geom_line(data = lag_si_I_20.dyn_i, aes(x = time, y = value, color = "Double exponential")) +
  geom_line(data = lag_si_I_20.dyn_i_norm, aes(x = time, y = value, color = "Normalization")) +
  geom_line(data = lag_si_I_20.dyn_i_logit, aes(x = time, y = value, color = "Logistic")) +
  facet_wrap(~variable, scales = "free") +
  labs(x = "Time post-infection (days)",
         y = "Values",
         color = "Legend") + 
  theme_bw()

# plot cr curves. Logistic and normalization is pretty similar to double exponential and has similar fitness. Stick with double exponential
ggplot() +
  geom_line(data = lag_si_I_20.cr_i, aes(x = cue_range, y = cr, color = "Double exponential")) +
  geom_line(data = lag_si_I_20.cr_i_norm, aes(x = cue_range, y = cr, color = "Normalization")) +
  geom_line(data = lag_si_I_20.cr_i_logit, aes(x = cue_range, y = cr, color = "Logistic")) +
  theme_bw()
```

#--------------------#
# Effects of cue range
# Figure 5B
#--------------------#
```{r}
# based on K
I_range_large <- seq(0, (3.7*10^5)*(8.5*10^6)/((3.7*10^5)-0.025*(8.5*10^6)), by = 1000) 

# large cue range
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_i_large <- optimParallel(par = c(0.5,0.5,0.5,0.5),
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range_large,
                      solver = "vode")
stopCluster(cl)
lag_si_I_20.opt_i_large$par
#0.8525727 -84.5341207  -2.1378408 0.3366813
lag_si_I_20.opt_i_large$value #10.33804 (lower)

# small cue range
I_range_small <- seq(0, 1.5*10^6, by = 1000) # about half
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_i_small <- optimParallel(par = c(0.5,0.5,0.5,0.5),
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 3,
                      cue = "I",
                      cue_range = I_range_small,
                      solver = "vode")
stopCluster(cl)

#did not converge
lag_si_I_20.opt_i_small$par #0.6011763 -4.4639660  4.8741573 -1.4995461
lag_si_I_20.opt_i_small$value #9.745052
```

# plot
```{r}
lag_si_I_20.cr_i_large <- par_to_df(lag_si_I_20.opt_i_large$par, I_range_large)
lag_si_I_20.cr_i_small <- par_to_df(lag_si_I_20.opt_i_small$par, I_range_small)

ggplot() +
  geom_line(data = lag_si_I_20.cr_i, aes(x = cue_range, y = cr, color = "2.18*10^6")) +
  geom_line(data = lag_si_I_20.cr_i_large, aes(x = cue_range, y = cr, color = "2.0*10^7")) +
  geom_line(data = lag_si_I_20.cr_i_small, aes(x = cue_range, y = cr, color = "1.5*10^6")) +
  xlim(0,2000000) +
  theme_bw()
```

#--------------------#
# Degrees of freedom
# Figure 5C
#--------------------#
```{r}
# df = 4
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_i_4 <- optimParallel(par = c(1.281065,-18.195055,150.068764,-2.839632,4.023027),
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 4,
                      cue = "I",
                      cue_range = I_range,
                      solver = "vode")
stopCluster(cl)

# did not converge. converged second time
lag_si_I_20.opt_i_4$par
#1.281065,-18.195055,150.068764,-2.839632,4.023027
#1.283670 -18.194529 150.068793  -2.839631 4.023027
lag_si_I_20.opt_i_4$value #-10.840171 
# 10.87755

# df = 5
cl <- makeCluster(detectCores()); setDefaultCluster(cl = cl)
lag_si_I_20.opt_i_5 <- optimParallel(par = rep(0.5,6),
                      fn = chabaudi_si_opt_lag, 
                      control = list(trace = 6, fnscale = -1),
                      immunity = "i",
                      parameters = parameters,
                      time_range = time_range,
                      df = 5,
                      cue = "I",
                      cue_range = I_range,
                      solver = "vode")
stopCluster(cl)

```

```{r}
lag_si_I_20.cr_i_4 <- par_to_df(lag_si_I_20.opt_i_4$par, I_range)

ggplot() +
  geom_line(data = lag_si_I_20.cr_i, aes(x = cue_range, y = cr, color = "df = 3")) +
  geom_line(data = lag_si_I_20.cr_i_4, aes(x = cue_range, y = cr, color = "df = 4")) +
  theme_bw()
```




